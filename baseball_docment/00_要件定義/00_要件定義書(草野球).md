要件定義書

1. システム概要

1.1. システムの目的
1.2. システム全体構成図
以下のMermaid図を記載してください。

mermaid  graph TB
      subgraph "クライアント"
          A[Flutterアプリ<br/>iOS/Android]
      end
      
      subgraph "Xserver VPS"
          B[Nginx<br/>Webサーバー]
          C[Laravel 10<br/>アプリケーション]
          D[MySQL 8.0<br/>データベース]
      end
      
      subgraph "外部サービス"
          E[Firebase Cloud Messaging<br/>プッシュ通知]
          F[Xserver SMTP<br/>メール送信]
          G[Google Maps<br/>地図表示]
      end
      
      A -->|HTTPS<br/>REST API| B
      B -->|FastCGI| C
      C -->|SQL| D
      C -->|FCM API| E
      C -->|SMTP| F
      A -->|Deep Link| G
      
      style A fill:#4CAF50
      style B fill:#2196F3
      style C fill:#FF9800
      style D fill:#9C27B0
      style E fill:#F44336
      style F fill:#3F51B5
      style G fill:#009688

1.3. 技術スタック一覧
1.4. 開発環境・本番環境の構成


2. アーキテクチャ設計

2.1. レイヤー構成（クリーンアーキテクチャ/MVC等の採用パターン）
2.2. ディレクトリ構造（Laravel側、Flutter側）
2.3. 通信方式（REST API、認証フロー）
2.4. 状態管理方式（Flutter）
2.5. 依存関係図


3. 全18機能の詳細定義
要件定義書のF-USR-008(チェックイン機能)と同じフォーマットで、以下の全18機能について詳細定義を記載してください。
各機能には必ず以下の項目を含めること:

ユーザーストーリー
概要
前提条件
事後状態(成功時)
入力(インプット) - 表形式
処理フロー - 番号付きリスト形式
出力(アウトプット) - 表形式
受け入れ条件(正常系・準正常系・異常系)
エラー処理 - 表形式

管理者向け機能(F-ADM-001?F-ADM-010)

F-ADM-001: ユーザー一覧表示機能
F-ADM-002: ユーザー詳細表示機能
F-ADM-003: ユーザー強制退会機能
F-ADM-004: 管理者用試合一覧表示機能
F-ADM-005: 管理者用試合詳細表示機能
F-ADM-006: 試合登録機能
F-ADM-007: 試合更新機能
F-ADM-008: 試合削除機能
F-ADM-009: プッシュ通知配信機能
F-ADM-010: メール配信機能

ユーザー向け機能(F-USR-001?F-USR-008)

F-USR-001: アカウント登録機能
F-USR-002: ログイン機能
F-USR-003: ログアウト機能
F-USR-004: パスワードリセット機能
F-USR-005: 試合一覧表示機能
F-USR-006: 試合参加登録機能
F-USR-007: 試合詳細表示機能
F-USR-008: チェックイン機能 [要件定義書に既に記載済み]


4. データベース設計

4.1. 物理ERD図
4.2. テーブル定義詳細
要件定義書のエンティティをもとに、物理テーブル名、カラム名、データ型、制約を記載
4.3. CREATE TABLE文(全テーブル)
以下のテンプレートに従って、全4テーブルのCREATE TABLE文を記載してください。
usersテーブル


sql  CREATE TABLE users (
      user_id CHAR(36) PRIMARY KEY COMMENT 'ユーザーID(UUID v4)',
      email VARCHAR(255) NOT NULL UNIQUE COMMENT 'メールアドレス',
      password VARCHAR(255) NOT NULL COMMENT 'パスワード(Bcryptハッシュ)',
      nickname VARCHAR(4) NOT NULL UNIQUE COMMENT 'ニックネーム(固定4文字)',
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '登録日時',
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
      deleted_at TIMESTAMP NULL DEFAULT NULL COMMENT '退会日時(論理削除)'
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ユーザー';
gamesテーブル、participationsテーブル、device_tokensテーブル
[同様に記載]

4.4. インデックス作成SQL文

sql  -- usersテーブル
  CREATE UNIQUE INDEX idx_email ON users(email);
  CREATE UNIQUE INDEX idx_nickname ON users(nickname);
  CREATE INDEX idx_deleted_at ON users(deleted_at);

  -- gamesテーブル、participationsテーブル、device_tokensテーブル
  [同様に全インデックスを記載]

4.5. トランザクション設計（どの処理をトランザクション境界とするか）
4.6. マスタデータ定義（都道府県ENUM、ポジションENUM等の初期データ)
4.7. マスタデータ投入SQL文
以下のSQL文を実行して、初期データを投入してください。

sql  -- 都道府県マスタは games テーブルの CHECK 制約で定義済み

  -- 初期管理者ユーザー作成(オプション)
  INSERT INTO users (user_id, email, password, nickname, created_at, updated_at)
  VALUES (
      UUID(),
      'admin@yourdomain.com',
      '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- password: "password"
      'かんり',
      NOW(),
      NOW()
  );

  -- 必要に応じて、テスト用の試合データなどを追加
  INSERT INTO games (game_id, place_name, game_date_time, address, prefecture, latitude, longitude, acceptable_radius, status, fee, capacity, created_at, updated_at)
  VALUES (
      UUID(),
      'テスト球場',
      DATE_ADD(NOW(), INTERVAL 7 DAY),
      '東京都新宿区西新宿2-8-1',
      '東京都',
      35.689614,
      139.691648,
      500,
      '募集中',
      1000,
      18,
      NOW(),
      NOW()
  );
```

---

### 5. API設計

- **5.1. API設計方針**(RESTful、命名規則、バージョニング)

- **5.2. 認証・認可方式**(JWT、トークンのライフタイム、リフレッシュトークン)

- **5.3. APIエンドポイント一覧表**
  
  | エンドポイント | HTTPメソッド | 機能概要 | 認証要否 | 対応する要件定義の機能ID |
  |---|---|---|---|---|

- **5.4. リクエスト/レスポンス仕様(全18APIの完全定義)**

  全18機能のAPIについて、以下のフォーマットで詳細を記載してください。

  #### テンプレート

  **[HTTPメソッド] [エンドポイント] - [機能ID]**

  **リクエストヘッダー**
```
  Content-Type: application/json
  Authorization: Bearer {token}  # 認証必須の場合
リクエストボディ(該当する場合)
json  {
    "field1": "type(説明)",
    "field2": "type(説明)"
  }
レスポンス(成功時)
json  {
    "data": {
      // 具体的なフィールドを記載
    },
    "meta": {
      "timestamp": "2025-10-18T12:34:56Z"
    }
  }
レスポンス(エラー時)
json  {
    "error": {
      "code": "E-XXX-XX",
      "message": "エラーメッセージ",
      "details": [...]
    },
    "meta": {
      "timestamp": "2025-10-18T12:34:56Z"
    }
  }
HTTPステータスコード

200: 成功(取得)
201: 成功(作成)
400: リクエストエラー
401: 認証エラー
403: 権限エラー
404: リソース未検出
409: 競合エラー
422: バリデーションエラー
500: サーバーエラー


全18APIの詳細

POST /api/v1/auth/register - F-USR-001
POST /api/v1/auth/login - F-USR-002
POST /api/v1/auth/logout - F-USR-003
POST /api/v1/auth/password/reset - F-USR-004
PUT /api/v1/auth/password/update - F-USR-004
GET /api/v1/games - F-USR-005
GET /api/v1/games/{gameId} - F-USR-007
POST /api/v1/games/{gameId}/participations - F-USR-006
POST /api/v1/games/{gameId}/checkin - F-USR-008
GET /api/v1/admin/users - F-ADM-001
GET /api/v1/admin/users/{userId} - F-ADM-002
DELETE /api/v1/admin/users/{userId} - F-ADM-003
GET /api/v1/admin/games - F-ADM-004
GET /api/v1/admin/games/{gameId} - F-ADM-005
POST /api/v1/games - F-ADM-006
PUT /api/v1/games/{gameId} - F-ADM-007
DELETE /api/v1/games/{gameId} - F-ADM-008
POST /api/v1/admin/notifications/push - F-ADM-009
POST /api/v1/admin/notifications/email - F-ADM-010
POST /api/v1/device-tokens

[各APIについてテンプレートに従って記載]

5.5. エラーレスポンス統一仕様
エラーコード完全一覧表(全機能網羅)
以下のフォーマットで、全てのエラーコードを一覧表にまとめてください。
コードHTTPステータスメッセージ発生条件対応機能IDE-400-01400リクエストが不正ですJSON形式エラー、必須パラメータ欠落全機能E-401-01401認証に失敗しましたログイン失敗(メール・パスワード不一致)F-USR-002...............
[全エラーコードを網羅的に記載]
5.6. ページネーション仕様
5.7. CORS設定


6. 画面設計

6.1. 画面一覧表
画面ID画面名画面概要対応する要件定義の機能ID

6.2. 画面遷移図(完全版)
以下のMermaid図を記載してください。
ユーザー向け画面遷移


mermaid  graph TD
      A[スプラッシュ画面] --> B{ログイン状態}
      B -->|未ログイン| C[ログイン画面]
      B -->|ログイン済み| D[試合一覧画面]
      C -->|新規登録| E[アカウント登録画面]
      C -->|パスワード忘れ| F[パスワードリセット画面]
      C -->|ログイン成功| D
      E -->|登録完了| D
      D -->|試合タップ| G[試合詳細画面]
      D -->|フィルター| H[フィルター画面]
      G -->|参加登録| I[参加登録画面]
      I -->|チーム・ポジション選択| G
      G -->|チェックイン| J[チェックイン処理]
      J -->|成功| G
      D -->|メニュー| K[設定画面]
      K -->|ログアウト| C
管理者向け画面遷移
mermaid  graph TD
      A[管理者ログイン画面] -->|ログイン成功| B[ダッシュボード画面]
      B -->|ユーザー管理| C[ユーザー一覧画面]
      C -->|詳細| D[ユーザー詳細画面]
      B -->|試合管理| E[試合一覧画面]
      E -->|登録| F[試合登録画面]
      E -->|編集| G[試合編集画面]
      E -->|詳細| H[試合詳細画面]
      B -->|通知管理| I[通知配信画面]
```

- **6.3. 各画面の詳細設計(全画面必須)**

  以下の全画面について、必ず詳細設計を記載してください。

  #### ユーザー向け画面(Flutter)

  **SCR-USR-001: ログイン画面**
  
  - 画面項目定義(表形式)
    
    | 項目名 | Widget型 | 必須/任意 | バリデーション | 備考 |
    |---|---|---|---|---|

  - レイアウト構成
    - Scaffoldから始まる階層構造で記載
    - 具体的なWidget名を使用(TextFormField、ElevatedButton等)

  - 状態管理
    - 使用するProvider名を列挙

  - 操作フロー
    1. [ステップ1]
    2. [ステップ2]
    ...

  - エラー表示
    - トースト/ダイアログ/インラインのいずれか明記

  [同様に以下の全画面について記載]
  - SCR-USR-002: アカウント登録画面
  - SCR-USR-003: パスワードリセット画面
  - SCR-USR-004: 試合一覧画面
  - SCR-USR-005: 試合詳細画面
  - SCR-USR-006: 参加登録画面
  - SCR-USR-007: 設定画面

  #### 管理者向け画面(Web)

  **SCR-ADM-001: 管理者ログイン画面**
  
  - 画面項目定義(表形式)
    
    | 項目名 | HTML要素 | 必須/任意 | バリデーション | 備考 |
    |---|---|---|---|---|

  - レイアウト構成
    - HTML要素の階層構造で記載

  - 操作フロー
    [番号付きリスト]

  [同様に以下の全画面について記載]
  - SCR-ADM-002: ダッシュボード画面
  - SCR-ADM-003: ユーザー一覧画面
  - SCR-ADM-004: ユーザー詳細画面
  - SCR-ADM-005: 試合一覧画面(管理者用)
  - SCR-ADM-006: 試合登録/編集画面
  - SCR-ADM-007: 試合詳細画面(管理者用)
  - SCR-ADM-008: 通知配信画面

---

### 7. セキュリティ設計

- **7.1. 認証フロー詳細**(ログイン、トークン検証、リフレッシュ)
- **7.2. 認可フロー詳細**(ユーザー種別による権限制御)
- **7.3. パスワード管理**(ハッシュ化アルゴリズム、ソルト)
- **7.4. トークン保存方式**(Flutter側: Secure Storage等)
- **7.5. 通信暗号化**(TLS 1.2以上)
- **7.6. 入力値検証**(サーバー側/クライアント側の役割分担)

- **7.7. OWASP Top 10対策(具体的実装方法)**

  以下の表形式で、各脆弱性に対する具体的な対策を記載してください。

  | 脆弱性 | 対策内容 | Laravel実装 | Flutter実装 |
  |--------|----------|-------------|-------------|
  | A01: アクセス制御の不備 | 認証・認可の徹底 | `auth:sanctum` Middlewareで全保護エンドポイントをガード、AdminMiddlewareで管理者権限チェック | トークンをSecure Storageに保存、全APIリクエストにAuthorizationヘッダー付与 |
  | ... | ... | ... | ... |

  [OWASP Top 10の全項目について記載]

---

### 8. 外部連携設計

- **8.1. Firebase Cloud Messaging連携詳細**

  #### 設定ファイル配置方法

  **iOS(GoogleService-Info.plist)**
  1. Firebase Consoleからプロジェクトを作成
  2. iOSアプリを追加
  3. `GoogleService-Info.plist`をダウンロード
  4. 以下のパスに配置:
```
  ios/
    └── Runner/
        └── GoogleService-Info.plist
```

  **Android(google-services.json)**
  1. Firebase ConsoleでAndroidアプリを追加
  2. `google-services.json`をダウンロード
  3. 以下のパスに配置:
```
  android/
    └── app/
        └── google-services.json
初期化コード(main.dart)
以下のコードをlib/main.dartに記載してください。
dart  import 'package:firebase_core/firebase_core.dart';
  import 'package:firebase_messaging/firebase_messaging.dart';
  import 'package:flutter_riverpod/flutter_riverpod.dart';

  // バックグラウンドメッセージハンドラー
  @pragma('vm:entry-point')
  Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
    await Firebase.initializeApp();
    print('バックグラウンドメッセージ受信: ${message.messageId}');
  }

  void main() async {
    WidgetsFlutterBinding.ensureInitialized();
    
    // Firebase初期化
    await Firebase.initializeApp();
    
    // [以下、完全な初期化コードを記載]
  }
デバイストークン登録処理
以下のコードをlib/core/services/fcm_service.dartに記載してください。
dart  import 'package:firebase_messaging/firebase_messaging.dart';
  // [完全なコードを記載]

デバイストークン登録フロー
プッシュ通知送信フロー
エラーハンドリング
8.2. メール配信(SMTP)

メールテンプレート設計
配信タイミング
配信失敗時のリトライ仕様


8.3. Google Maps連携

地図アプリ起動方式(ディープリンク)




9. 位置情報・チェックイン機能設計

9.1. 位置情報取得方式(GPS、権限要求フロー)
9.2. 距離計算ロジック(Haversine formula実装)
以下のコードをlib/core/utils/distance_calculator.dartに記載してください。

dart  import 'dart:math';

  class DistanceCalculator {
    /// 2地点間の距離を計算(Haversine formula)
    /// 
    /// @param lat1 地点1の緯度
    /// @param lon1 地点1の経度
    /// @param lat2 地点2の緯度
    /// @param lon2 地点2の経度
    /// @return 距離(メートル)
    static double calculate(
      double lat1,
      double lon1,
      double lat2,
      double lon2,
    ) {
      const double earthRadius = 6371000; // 地球の半径(メートル)
      
      // [完全な実装コードを記載]
    }
    
    /// 度をラジアンに変換
    static double _toRadians(double degrees) {
      return degrees * pi / 180;
    }
    
    /// 指定された距離以内かどうかを判定
    static bool isWithinRange(
      double lat1,
      double lon1,
      double lat2,
      double lon2,
      double threshold,
    ) {
      // [完全な実装コードを記載]
    }
  }

9.3. チェックイン判定フロー
9.4. 時間帯制御(試合開始30分前?1時間後)


10. 通知・メール設計

10.1. 通知種別一覧
10.2. プッシュ通知テンプレート完全定義
通知IDタイトル本文トリガー優先度対象ユーザーPUSH-001試合登録完了「{place_name}」の試合を登録しました管理者が試合登録時通常登録した管理者..................
[全7種類のプッシュ通知テンプレートを記載]
10.3. メールテンプレート完全定義
メールID件名本文(HTML形式で記載)トリガー対象ユーザーMAIL-001【草野球マッチング】アカウント登録完了<h2>アカウント登録完了</h2><p>{nickname}様</p><p>草野球マッチングアプリへのご登録ありがとうございます。</p>...アカウント登録時登録したユーザー...............
[全7種類のメールテンプレートを完全に記載]


11. バッチ処理設計

11.1. バッチ処理の実装コード
試合ステータス自動更新バッチ
app/Console/Commands/UpdateGameStatus.phpファイルに以下を記載してください。

php  <?php

  namespace App\Console\Commands;

  use Illuminate\Console\Command;
  use App\Models\Game;
  use Carbon\Carbon;

  class UpdateGameStatus extends Command
  {
      protected $signature = 'games:update-status';
      protected $description = '試合ステータスを自動更新(募集中/満員→開催済み)';

      public function handle()
      {
          // [完全な実装コードを記載]
      }
  }
プッシュ通知配信バッチ
app/Console/Commands/SendGameReminder.phpファイルに以下を記載してください。
php  <?php
  // [完全な実装コードを記載]

11.2. cronスケジュール設定
Laravelスケジューラーの設定
app/Console/Kernel.phpファイルに以下を記載してください。

php  <?php

  namespace App\Console;

  use Illuminate\Console\Scheduling\Schedule;
  use Illuminate\Foundation\Console\Kernel as ConsoleKernel;

  class Kernel extends ConsoleKernel
  {
      protected function schedule(Schedule $schedule): void
      {
          // 試合ステータス自動更新バッチ(毎時0分実行)
          $schedule->command('games:update-status')
              ->cron('0 * * * *')
              ->withoutOverlapping()
              ->runInBackground();
          
          // [以下、全バッチ処理のスケジュール設定を記載]
      }
  }
システムcronの設定
以下のコマンドでcrontabに登録してください。
bash  sudo crontab -e
  # 以下を追加:
  * * * * * cd /var/www/grass-baseball-matching && php artisan schedule:run >> /dev/null 2>&1

11.3. エラーハンドリング


12. ログ設計

12.1. ログ種別(アクセスログ、エラーログ、操作ログ)
12.2. ログ出力項目(JSONスキーマ)
以下のJSON形式でログを出力してください。
アクセスログ


json  {
    "timestamp": "2025-10-18T12:34:56Z",
    "level": "INFO",
    "type": "access",
    "method": "POST",
    "path": "/api/v1/auth/login",
    "status": 200,
    "duration_ms": 245,
    "ip_address": "192.168.1.1",
    "user_agent": "Mozilla/5.0...",
    "user_id": "xxx-xxx-xxx" // ログイン済みの場合のみ
  }
エラーログ、操作ログ
[同様に完全なJSONスキーマを記載]

12.3. ログレベル定義
12.4. ログ保存期間・ローテーション


13. 監視設計

13.1. 監視項目(CPU、メモリ、ディスク、エラーレート)
13.2. アラート閾値
13.3. 監視ツール(候補)


14. バックアップ・リカバリ設計

14.1. バックアップ対象
14.2. バックアップ頻度・世代管理
14.3. リストア手順概要


15. テスト方針詳細

15.1. 単体テスト(Laravel)
テストクラステストメソッドテスト内容期待結果
[全Service・Repositoryクラスのテストケースを記載]
15.2. 単体テスト(Flutter)
| テストファイル
再試行宮続ける| テスト内容 | 期待結果 |
|---------------|-----------|----------|
[全Provider・Utilクラスのテストケースを記載]

15.3. 統合テスト
エンドポイントテストケース期待結果
[全18エンドポイントの正常系・異常系テストケースを記載]
15.4. E2Eテスト
シナリオIDシナリオ名ステップ期待結果
[全主要ユーザーフローのE2Eテストシナリオを記載]
15.5. モック対象・方法


16. デプロイ設計

16.1. デプロイフロー
16.2. CI/CDパイプライン概要
16.3. 環境構築手順詳細
Nginx設定ファイル
/etc/nginx/sites-available/grass-baseball-matchingファイルの完全な内容を以下に記載してください。

nginx  server {
      listen 80;
      listen [::]:80;
      server_name yourdomain.com;
      
      # HTTPSへリダイレクト
      return 301 https://$server_name$request_uri;
  }

  server {
      listen 443 ssl http2;
      listen [::]:443 ssl http2;
      server_name yourdomain.com;
      
      root /var/www/grass-baseball-matching/public;
      index index.php;
      
      # SSL証明書設定
      ssl_certificate /path/to/ssl/certificate.crt;
      ssl_certificate_key /path/to/ssl/private.key;
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_ciphers HIGH:!aNULL:!MD5;
      
      # [以下、完全なNginx設定を記載]
  }
Laravelデプロイコマンド一覧
以下のコマンドを順番に実行してください。
bash  # 1. リポジトリクローン
  cd /var/www
  git clone https://github.com/youraccount/grass-baseball-matching.git
  cd grass-baseball-matching

  # 2. Composer インストール
  composer install --no-dev --optimize-autoloader

  # [以下、全デプロイコマンドを番号付きで記載]
Flutterビルド・デプロイコマンド
iOS
bash  # 1. 依存パッケージインストール
  cd flutter_app
  flutter pub get

  # [以下、全ビルドコマンドを番号付きで記載]
Android
bash  # [全ビルドコマンドを番号付きで記載]

16.4. 環境変数一覧(.envファイルの全項目)
以下の環境変数を必ず全て定義してください。

bash  # アプリケーション基本設定
  APP_NAME="GrassBaseballMatching"
  APP_ENV=production  # local/staging/production
  APP_KEY=base64:xxxxx  # php artisan key:generate で生成
  APP_DEBUG=false  # 本番環境では必ずfalse
  APP_URL=https://yourdomain.com

  # ログ設定
  LOG_CHANNEL=stack
  LOG_DEPRECATIONS_CHANNEL=null
  LOG_LEVEL=info  # debug/info/warning/error/critical

  # データベース設定
  DB_CONNECTION=mysql
  DB_HOST=127.0.0.1
  DB_PORT=3306
  DB_DATABASE=grass_baseball_matching
  DB_USERNAME=db_user
  DB_PASSWORD=secure_password

  # [以下、全環境変数を記載]
```

---

### 17. 移行設計

- **17.1. データ移行要否**(今回は不要と記載)
- **17.2. 初期データ投入手順**

---

### 18. 制約事項・前提条件

- **18.1. インフラ制約**(Xserver VPS)
- **18.2. 外部サービス制約**
- **18.3. 技術的制約**

---

### 19. 用語集

- **19.1. 技術用語**
- **19.2. ドメイン用語**

---

## ?? 技術選定の固定ルール

以下の技術選定は**必ず固定**して使用してください。これにより、出力の一貫性を保ちます。

### バックエンド(Laravel)

#### 認証方式
- **Laravel Sanctum**を使用する
- トークンの種類: Personal Access Token(PAT)
- アクセストークンの有効期限: **24時間**
- リフレッシュトークンは使用しない(有効期限切れ時は再ログインを要求)

#### ディレクトリ構造
- **Laravel標準のMVCディレクトリ構造**を採用する
- 主要ディレクトリ:
```
  app/
    ├── Http/
    │   ├── Controllers/
    │   ├── Middleware/
    │   └── Requests/
    ├── Models/
    ├── Services/
    └── Repositories/
```

#### パスワードハッシュ化
- **Bcryptアルゴリズム**を使用(Laravelデフォルト)
- コストパラメータ: 10(デフォルト)

#### 外部キー制約
- 全ての外部キーに制約を設定する
- ON DELETE: **RESTRICT**(削除時は関連レコードの存在チェックを行う)
- ON UPDATE: **CASCADE**

#### トランザクション分離レベル
- **REPEATABLE READ**(MySQL 8.0のデフォルト)を使用

### フロントエンド(Flutter)

#### 状態管理
- **Riverpod 2.x**を使用する

#### ディレクトリ構造
- **Feature-First構造**を採用する
- 主要ディレクトリ:
```
  lib/
    ├── features/
    │   ├── auth/
    │   ├── game/
    │   └── checkin/
    ├── core/
    │   ├── providers/
    │   ├── models/
    │   └── services/
    └── shared/
        ├── widgets/
        └── utils/
トークン保存方式

flutter_secure_storageパッケージを使用
iOS: Keychain
Android: EncryptedSharedPreferences

位置情報取得

geolocatorパッケージを使用
精度: high(高精度GPS)
権限要求タイミング: チェックイン機能初回使用時

距離計算

Haversine formula(ヒュベニの公式ではない)を使用
理由: 誤差が小さく、グローバルで使用可能

API設計
命名規則(完全固定)
リソースエンドポイントメソッドユーザー登録/api/v1/auth/registerPOSTログイン/api/v1/auth/loginPOSTログアウト/api/v1/auth/logoutPOSTパスワードリセット要求/api/v1/auth/password/resetPOSTパスワードリセット実行/api/v1/auth/password/updatePUT試合一覧取得/api/v1/gamesGET試合詳細取得/api/v1/games/{gameId}GET試合登録/api/v1/gamesPOST試合更新/api/v1/games/{gameId}PUT試合削除/api/v1/games/{gameId}DELETE試合参加登録/api/v1/games/{gameId}/participationsPOSTチェックイン/api/v1/games/{gameId}/checkinPOSTユーザー一覧取得/api/v1/admin/usersGETユーザー詳細取得/api/v1/admin/users/{userId}GETユーザー強制退会/api/v1/admin/users/{userId}DELETEプッシュ通知配信/api/v1/admin/notifications/pushPOSTメール配信/api/v1/admin/notifications/emailPOSTデバイストークン登録/api/v1/device-tokensPOST
レスポンス構造(固定フォーマット)
成功時(200, 201)
json{
  "data": {
    // リソースデータ
  },
  "meta": {
    "timestamp": "2025-10-18T12:34:56Z"
  }
}
成功時(リスト取得)
json{
  "data": [
    // リソースの配列
  ],
  "meta": {
    "current_page": 1,
    "per_page": 20,
    "total": 100,
    "last_page": 5,
    "timestamp": "2025-10-18T12:34:56Z"
  }
}
エラー時(4xx, 5xx)
json{
  "error": {
    "code": "E-XXX-XX",
    "message": "エラーメッセージ",
    "details": [
      {
        "field": "email",
        "message": "メールアドレスの形式が正しくありません"
      }
    ]
  },
  "meta": {
    "timestamp": "2025-10-18T12:34:56Z"
  }
}
```

#### ページネーション仕様
- 方式: **オフセットベース**(`page`と`per_page`パラメータ)
- デフォルトページサイズ: **20件**
- 最大ページサイズ: **100件**
- パラメータ:
  - `page`: ページ番号(デフォルト: 1)
  - `per_page`: 1ページあたりの件数(デフォルト: 20)

#### CORS設定
- 許可オリジン: 本番環境のドメインのみ(開発時は`*`)
- 許可メソッド: `GET, POST, PUT, DELETE, OPTIONS`
- 許可ヘッダー: `Content-Type, Authorization, Accept`
- 認証情報: `credentials: true`

#### レートリミット
- 認証不要エンドポイント: **60回/分/IP**
- 認証必須エンドポイント: **120回/分/ユーザー**
- ログイン: **5回/分/IP**(総当たり攻撃対策)

### データベース設計

#### テーブル名・カラム名の命名規則(完全固定)

**テーブル名**
- 要件定義書のエンティティ名をスネークケース複数形に変換
- 例: `User` → `users`, `Game` → `games`, `Participation` → `participations`

**カラム名**
- 要件定義書の属性名をスネークケースに変換
- 例: `userId` → `user_id`, `gameDateTime` → `game_date_time`

**固定のカラム命名**

| 論理名 | 物理名 | 型 | 備考 |
|-------|--------|-----|------|
| ユーザーID | `user_id` | CHAR(36) | UUID v4 |
| 試合ID | `game_id` | CHAR(36) | UUID v4 |
| 参加情報ID | `participation_id` | CHAR(36) | UUID v4 |
| デバイストークンID | `device_token_id` | CHAR(36) | UUID v4 |
| メールアドレス | `email` | VARCHAR(255) | |
| パスワード | `password` | VARCHAR(255) | Bcryptハッシュ |
| ニックネーム | `nickname` | VARCHAR(4) | 固定4文字 |
| 場所名 | `place_name` | VARCHAR(254) | |
| 開催日時 | `game_date_time` | DATETIME | |
| 住所 | `address` | VARCHAR(254) | |
| 都道府県 | `prefecture` | VARCHAR(10) | ENUM型として実装 |
| 緯度 | `latitude` | DECIMAL(10, 8) | |
| 経度 | `longitude` | DECIMAL(11, 8) | |
| 許容半径 | `acceptable_radius` | INT UNSIGNED | メートル単位 |
| ステータス | `status` | VARCHAR(20) | ENUM型として実装 |
| 参加費 | `fee` | INT UNSIGNED | 円単位、NULL可 |
| 募集人数 | `capacity` | INT UNSIGNED | |
| チーム区分 | `team_division` | VARCHAR(20) | ENUM型として実装 |
| 守備ポジション | `position` | VARCHAR(20) | ENUM型として実装 |
| トークン | `token` | VARCHAR(255) | FCMトークン |
| デバイス種別 | `device_type` | VARCHAR(10) | 'ios' or 'android' |
| 登録日時 | `created_at` | TIMESTAMP | |
| 更新日時 | `updated_at` | TIMESTAMP | |
| 退会日時 | `deleted_at` | TIMESTAMP | NULL可 |

#### インデックス設計(固定)

以下のインデックスを**必ず作成**してください:

**usersテーブル**
- `email` (UNIQUE): ログイン検索用
- `nickname` (UNIQUE): 重複チェック用
- `deleted_at`: 論理削除フィルタ用

**gamesテーブル**
- `game_date_time`: 日時範囲検索用
- `prefecture`: 都道府県絞り込み用
- `status`: ステータス絞り込み用
- `(status, game_date_time)`: 複合インデックス(募集中の試合一覧取得用)

**participationsテーブル**
- `user_id`: ユーザーの参加試合一覧取得用
- `game_id`: 試合の参加者一覧取得用
- `(user_id, game_id)` (UNIQUE): 重複参加防止用
- `status`: ステータス絞り込み用

**device_tokensテーブル**
- `user_id`: ユーザーのデバイス一覧取得用
- `token` (UNIQUE): トークン重複防止用

#### ENUM値の定義(固定)

**prefecture(都道府県)**
```
'北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
'茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
'新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
'静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
'奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
'徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
'熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
```

**game.status(試合ステータス)**
```
'募集中', '満員', '開催済み', '中止'
```
デフォルト値: `'募集中'`

**participation.team_division(チーム区分)**
```
'チームA', 'チームB'
```

**participation.position(守備ポジション)**
```
'投手', '捕手', '一塁手', '二塁手', '三塁手', '遊撃手',
'左翼手', '中堅手', '右翼手'
```

**participation.status(参加ステータス)**
```
'参加確定', 'チェックイン済'
```
デフォルト値: `'参加確定'`

**device_token.device_type(デバイス種別)**
```
'ios', 'android'
バリデーション設計
共通ルール

サーバー側で必ず全項目を検証する
クライアント側でも同じルールで検証し、UX向上を図る
エラーメッセージは日本語で表示する

各項目のバリデーションルール(固定)
email(メールアドレス)

必須
形式: RFC 5322準拠
最大長: 255文字
一意制約(既存ユーザーとの重複不可)

password(パスワード)

必須
最小長: 8文字
最大長: 72文字(Bcryptの制限)
含む文字種: 英大文字・英小文字・数字のうち2種類以上
登録時とパスワード変更時に確認入力を求める

nickname(ニックネーム)

必須
固定長: 4文字(全角・半角問わず)
使用可能文字: ひらがな、カタカナ、漢字、英数字
一意制約(既存ユーザーとの重複不可)

place_name(場所名)

必須
最大長: 254文字

game_date_time(開催日時)

必須
未来の日時であること
最小: 現在時刻の1時間後
最大: 現在時刻の1年後

address(住所)

必須
最大長: 254文字

prefecture(都道府県)

必須
許可値: 上記ENUM値のいずれか

latitude(緯度)

必須
範囲: -90 ? latitude ? 90
小数点以下8桁まで

longitude(経度)

必須
範囲: -180 ? longitude ? 180
小数点以下8桁まで

acceptable_radius(許容半径)

必須
範囲: 1 ? acceptable_radius ? 1999(メートル)
整数

fee(参加費)

任意(NULL可)
範囲: 0以上の整数
単位: 円

capacity(募集人数)

必須
最小値: 18(9人×2チーム)
最大値: 100
デフォルト値: 18

画面設計
エラー表示方式(固定)
トースト/スナックバー

使用場面: 軽微な成功メッセージ、一時的なエラー
表示位置: 画面下部
表示時間: 3秒
例: 「チェックインしました」

ダイアログ

使用場面: 確認が必要な操作、重要なエラー
例: 「本当に退会しますか?」、「位置情報の取得に失敗しました」

インラインエラー

使用場面: フォーム入力時のバリデーションエラー
表示位置: 該当入力欄の直下
色: 赤色(#F44336)
例: 「メールアドレスの形式が正しくありません」

ローディング表示

CircularProgressIndicator(円形スピナー)を使用
全画面ローディング: 画面中央に半透明背景で表示
部分ローディング: 該当コンポーネント内に表示

通知・メール設計
プッシュ通知の優先度

高優先度: 試合開始1時間前の通知、緊急のお知らせ
通常優先度: 試合登録完了、参加登録完了

メール形式

HTMLメールを使用
プレーンテキストのフォールバック版も用意

配信失敗時のリトライ

リトライ回数: 3回
リトライ間隔: 5分、15分、30分(指数バックオフ)
3回失敗した場合はログに記録し、手動対応

バッチ処理設計
試合ステータス自動更新バッチ

実行タイミング: 毎時0分(cron: 0 * * * *)
更新ロジック:

現在時刻がgame_date_timeより1時間以上後かつステータスが「募集中」「満員」の場合 → 「開催済み」に更新



排他制御

データベースロックを使用
SELECT ... FOR UPDATEでレコードをロック
同時実行防止のため、バッチ実行フラグをRedisに保存(TTL: 1時間)

ログ設計
ログフォーマット

JSON形式で出力
含まれる項目:

json  {
    "timestamp": "2025-10-18T12:34:56Z",
    "level": "INFO",
    "message": "User logged in",
    "context": {
      "user_id": "xxx-xxx-xxx",
      "ip_address": "192.168.1.1",
      "user_agent": "..."
    }
  }
ログレベル

DEBUG: 開発時のデバッグ情報
INFO: 通常の動作ログ
WARNING: 警告(処理は継続)
ERROR: エラー(処理は失敗)
CRITICAL: 致命的エラー(システム停止)


?? 出力時の注意事項
1. 具体性を重視

抽象的な説明ではなく、実装レベルで参照できる具体的な内容を記載してください
例: 「認証を行う」ではなく、「Laravel Sanctumを使用し、Personal Access Tokenで認証し、有効期限は24時間とする」

2. 上記の固定ルールを必ず遵守

技術選定、命名規則、レスポンス構造、バリデーションルールなど、全て上記の固定ルールに従ってください
判断に迷う箇所があっても、上記ルールを優先してください

3. 図表の活用

Mermaid記法で図を記載してください
システム構成図、画面遷移図、シーケンス図など

4. 要件定義書との対応

各設計項目が要件定義書のどの機能に対応するか明記してください
機能ID(F-USR-001等)を参照してください

5. 完全性

要件定義書に記載された全18機能について、API設計・画面設計を網羅してください
全18機能のAPIエンドポイント、画面、処理フローを漏れなく記載してください

6. 実装可能性

Laravel 10、Flutter 3.16で実装可能な技術のみを選定してください
利用するパッケージ名も具体的に記載してください

7. 一貫性の保持

命名規則、レスポンス構造、エラーハンドリングなど、全て統一されたルールで記載してください
同じ概念には同じ用語を使用してください


? 出力の必須要件(CRITICAL)
以下の項目は必ず全て完全に記載してください。一つでも欠けている場合は、基本設計書として不完全です。
チェックリスト

 全18機能の詳細定義(ユーザーストーリー、前提条件、処理フロー、エラー処理を含む)
 全18APIのリクエスト/レスポンスJSONスキーマ
 全画面(ユーザー向け7画面+管理者向け8画面)の詳細設計
 エラーコード完全一覧表(30種類以上)
 プッシュ通知テンプレート7種類の完全定義
 メールテンプレート7種類の完全定義(HTML形式)
 CREATE TABLE文(4テーブル全て)
 インデックス作成SQL文(全インデックス)
 マスタデータ投入SQL文
 環境変数一覧(.envファイルの全項目)
 Nginx設定ファイル(完全版)
 Laravelデプロイコマンド一覧
 Flutterビルドコマンド一覧(iOS/Android)
 Firebase FCM初期化コード
 FCMデバイストークン登録コード
 距離計算アルゴリズム実装コード
 バッチ処理のcron設定
 バッチ処理の実装コード
 システム構成図(Mermaid)
 画面遷移図(Mermaid、ユーザー向け+管理者向け)
 OWASP Top 10対策の具体的実装方法(表形式)
 ログフォーマットJSONスキーマ(3種類)
 テストケース一覧(単体・統合・E2E)

出力形式の注意

全てのコードは完全なものを記載し、「...」や「[以下省略]」などの省略表現を使用しない
全てのテーブルは表形式で記載する
全ての図はMermaid記法で記載する
全てのSQLは実行可能な完全なものを記載する
全てのコード例は動作する完全なものを記載する

一貫性の確保

命名規則は全て上記の固定ルールに従う
レスポンス構造は全て固定フォーマットに従う
エラーコードは完全一覧表に記載されたもののみを使用する
バリデーションルールは固定ルールに従う


?? 出力形式

Markdown形式で出力してください
長文になる場合は、章ごとに分割して出力しても構いません
表は可能な限りMarkdownテーブル形式で記載してください


それでは、基本設計書の作成を開始してください。再試行Claudeは間違えることがあります。回答内容を必ずご確認ください。 Sonnet 4.5