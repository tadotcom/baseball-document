# コーディング規約

**プロジェクト名:** 草野球マッチングアプリ  
**バージョン:** 1.0  
**最終更新日:** 2025-10-23

---

## 1. 命名規則

### 1.1 変数名

| 言語 | ルール | 例 | 備考 |
|------|--------|-----|------|
| PHP (Laravel) | スネークケース | `$user_name`, `$game_date_time` | 小文字 + アンダースコア |
| Dart (Flutter) | キャメルケース | `userName`, `gameDateTime` | 最初は小文字 |

### 1.2 関数名

| 言語 | ルール | 例 | 備考 |
|------|--------|-----|------|
| PHP (Laravel) | スネークケース | `get_user_by_id()`, `create_game()` | 動詞で始める |
| Dart (Flutter) | キャメルケース | `getUserById()`, `createGame()` | 動詞で始める |

### 1.3 クラス名

| 言語 | ルール | 例 | 備考 |
|------|--------|-----|------|
| PHP (Laravel) | パスカルケース | `GameController`, `AuthService` | 名詞、単数形 |
| Dart (Flutter) | パスカルケース | `GameListScreen`, `AuthProvider` | 名詞、単数形 |

### 1.4 定数名

| 言語 | ルール | 例 | 備考 |
|------|--------|-----|------|
| PHP (Laravel) | アッパースネークケース | `MAX_CAPACITY`, `DEFAULT_FEE` | 全て大文字 |
| Dart (Flutter) | アッパースネークケース | `MAX_CAPACITY`, `DEFAULT_FEE` | 全て大文字 |

### 1.5 ファイル名

| 言語 | ルール | 例 | 備考 |
|------|--------|-----|------|
| PHP (Laravel) | パスカルケース | `GameController.php`, `AuthService.php` | クラス名と同じ |
| Dart (Flutter) | スネークケース | `game_list_screen.dart`, `auth_provider.dart` | 全て小文字 |

---

## 2. コメント規約

### 2.1 必須コメント箇所

- ✅ 全ての public メソッドの上
- ✅ 複雑なロジックの前
- ✅ 外部API呼び出しの前
- ✅ マジックナンバーの説明

### 2.2 コメントフォーマット

**PHP (Laravel):**
```php
/**
 * ユーザーをIDで取得する
 * 
 * @param string $userId ユーザーID (UUID)
 * @return User ユーザーオブジェクト
 * @throws ModelNotFoundException ユーザーが見つからない場合
 */
public function get_user_by_id(string $userId): User
{
    return User::findOrFail($userId);
}
```

**Dart (Flutter):**
```dart
/// ユーザーをIDで取得する
/// 
/// [userId] ユーザーID (UUID)
/// 戻り値: ユーザーオブジェクト
/// 例外: UserNotFoundException ユーザーが見つからない場合
Future<User> getUserById(String userId) async {
  // 実装
}
```

### 2.3 インラインコメント

```php
// 良い例
$radius = 500; // チェックイン許容半径（メートル）

// 悪い例
$r = 500; // 半径
```

---

## 3. ファイル構成

### 3.1 基本原則

- ✅ 1ファイル1クラス
- ✅ ファイル名とクラス名を一致させる
- ✅ 関連するファイルは同じディレクトリに配置

### 3.2 Laravel ディレクトリ構成

```
app/
├── Http/
│   ├── Controllers/     # コントローラー
│   ├── Requests/        # フォームリクエスト
│   └── Resources/       # APIリソース
├── Models/              # Eloquentモデル
├── Services/            # ビジネスロジック
└── Repositories/        # データアクセス層
```

### 3.3 Flutter ディレクトリ構成

```
lib/
├── data/                # データ層
├── domain/              # ドメイン層
├── presentation/        # プレゼンテーション層
└── core/                # 共通機能
```

---

## 4. インデント・フォーマット

### 4.1 インデント

| 言語 | ルール |
|------|--------|
| PHP | 4スペース |
| Dart | 2スペース |

### 4.2 行の長さ

- **最大**: 120文字
- **推奨**: 80文字

### 4.3 改行

```php
// 良い例
$result = $this->gameService->createGame(
    $placeName,
    $gameDateTime,
    $address
);

// 悪い例
$result = $this->gameService->createGame($placeName, $gameDateTime, $address, $prefecture, $latitude, $longitude);
```

---

## 5. 条件分岐・ループ

### 5.1 if文

```php
// 良い例
if ($user->isAdmin()) {
    // 処理
}

// 悪い例
if ($user->is_admin == true) {
    // 処理
}
```

### 5.2 早期リターン

```php
// 良い例
if (!$user) {
    return null;
}

$user->activate();
return $user;

// 悪い例
if ($user) {
    $user->activate();
    return $user;
} else {
    return null;
}
```

---

## 6. 例外処理

### 6.1 例外の使用

```php
// 良い例
if (!$game) {
    throw new GameNotFoundException("試合が見つかりません");
}

// 悪い例
if (!$game) {
    return ['error' => 'not found'];
}
```

### 6.2 try-catch

```php
try {
    $result = $this->externalApi->call();
} catch (ApiException $e) {
    Log::error("API呼び出し失敗: {$e->getMessage()}");
    throw new ServiceException("外部サービスとの通信に失敗しました");
}
```

---

## 7. データベース

### 7.1 クエリビルダー vs 生SQL

- ✅ **使用推奨**: Eloquent ORM、クエリビルダー
- ❌ **使用禁止**: 生SQL（セキュリティリスク）

```php
// 良い例
$users = User::where('deleted_at', null)->get();

// 悪い例
$users = DB::select("SELECT * FROM users WHERE deleted_at IS NULL");
```

### 7.2 N+1問題の回避

```php
// 良い例
$games = Game::with('participants')->get();

// 悪い例
$games = Game::all();
foreach ($games as $game) {
    $participants = $game->participants; // N+1発生
}
```

---

## 8. セキュリティ

### 8.1 入力値の検証

- ✅ **サーバー側で必ず検証**（FormRequestを使用）
- ✅ クライアント側でも検証（UX向上）

### 8.2 パスワード

```php
// 良い例
$user->password = Hash::make($request->password);

// 悪い例
$user->password = md5($request->password);
```

### 8.3 SQLインジェクション対策

```php
// 良い例
User::where('email', $email)->first();

// 悪い例
DB::select("SELECT * FROM users WHERE email = '{$email}'");
```

---

## 9. テスト

### 9.1 テストファイル命名

| 対象ファイル | テストファイル |
|------------|---------------|
| `GameService.php` | `GameServiceTest.php` |
| `game_list_screen.dart` | `game_list_screen_test.dart` |

### 9.2 テストメソッド命名

```php
// 良い例
public function test_user_can_register_with_valid_data()
public function test_user_cannot_register_with_duplicate_email()

// 悪い例
public function testRegister()
public function test1()
```

---

## 10. Git コミットメッセージ

### 10.1 フォーマット

```
<type>: <subject>

<body>
```

### 10.2 Type一覧

| Type | 説明 | 例 |
|------|------|-----|
| feat | 新機能 | `feat: 試合参加登録機能を追加` |
| fix | バグ修正 | `fix: チェックイン時の距離計算を修正` |
| docs | ドキュメント | `docs: READMEを更新` |
| style | フォーマット | `style: インデントを修正` |
| refactor | リファクタリング | `refactor: AuthServiceを分割` |
| test | テスト追加 | `test: GameServiceのテストを追加` |
| chore | その他 | `chore: 依存パッケージを更新` |

### 10.3 例

```
feat: 試合一覧画面にフィルター機能を追加

- 都道府県での絞り込み
- 日付範囲での絞り込み
- フィルター状態の永続化
```

---

## 11. 禁止事項

### ❌ 絶対にやってはいけないこと

1. **機密情報のハードコーディング**
   ```php
   // NG
   $apiKey = "abc123def456";
   
   // OK
   $apiKey = env('API_KEY');
   ```

2. **デバッグコードのコミット**
   ```php
   // NG
   dd($user);
   var_dump($data);
   console.log("debug");
   ```

3. **TODOの放置**
   ```php
   // NG: TODOを残したままマージ
   // TODO: あとで実装
   
   // OK: TODOを解消してからマージ
   ```

4. **マジックナンバー**
   ```php
   // NG
   if ($count > 18) { ... }
   
   // OK
   const MIN_CAPACITY = 18;
   if ($count > self::MIN_CAPACITY) { ... }
   ```

---

## 12. レビュー基準

### 12.1 コードレビューチェックリスト

- [ ] 命名規則に従っているか
- [ ] コメントが適切に記載されているか
- [ ] テストが書かれているか
- [ ] セキュリティ問題がないか
- [ ] パフォーマンス問題がないか
- [ ] エラーハンドリングが適切か
- [ ] ログが適切に出力されているか

---

## 13. ツール

### 13.1 Laravel (PHP)

- **Linter**: PHP CS Fixer
- **静的解析**: PHPStan (Level 5以上)
- **テスト**: PHPUnit

```bash
# フォーマット
./vendor/bin/php-cs-fixer fix

# 静的解析
./vendor/bin/phpstan analyse

# テスト
php artisan test
```

### 13.2 Flutter (Dart)

- **Linter**: dart analyze
- **フォーマット**: dart format
- **テスト**: flutter test

```bash
# フォーマット
dart format lib/

# 静的解析
dart analyze

# テスト
flutter test
```

---

## 14. パフォーマンス

### 14.1 N+1問題

```php
// NG
$games = Game::all();
foreach ($games as $game) {
    echo $game->participants->count();
}

// OK
$games = Game::withCount('participants')->get();
foreach ($games as $game) {
    echo $game->participants_count;
}
```

### 14.2 不要なクエリ

```php
// NG
if (User::where('email', $email)->exists()) {
    $user = User::where('email', $email)->first();
}

// OK
$user = User::where('email', $email)->first();
if ($user) {
    // 処理
}
```

---

## 付録: よくある間違い

### A. 変数名の誤り

```php
// NG
$data, $temp, $x, $arr

// OK
$users, $gameDateTime, $participantCount, $errorMessages
```

### B. 過度なネスト

```php
// NG
if ($a) {
    if ($b) {
        if ($c) {
            // 処理
        }
    }
}

// OK
if (!$a) return;
if (!$b) return;
if (!$c) return;

// 処理
```

### C. 無駄なコメント

```php
// NG
// ユーザーIDを取得
$userId = $user->id;

// OK（コメント不要）
$userId = $user->id;
```

---

**この規約に従って、一貫性のある高品質なコードを書きましょう！**
