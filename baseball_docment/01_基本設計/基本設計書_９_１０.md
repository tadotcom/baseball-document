第9章 位置情報・チェックイン機能設計9.1. 位置情報取得方式 (Flutter)採用パッケージ: geolocator 1要求精度: LocationAccuracy.high （高精度GPS） 2権限要求フロー:ユーザーが初めて「チェックイン」ボタン（SCR-USR-005 試合詳細画面）をタップした際に、位置情報利用の許可を要求する 3。geolocator の checkPermission() で現在のステータスを確認。ステータスが denied の場合、requestPermission() を呼び出し、OSの許可ダイアログを表示する。ステータスが deniedForever （永続的に拒否）の場合、アプリの設定画面へ誘導するダイアログを表示する。ステータスが granted の場合のみ、getCurrentPosition() を呼び出して位置情報を取得する。エラーハンドリング:位置情報サービス（GPS）が無効の場合、E-400-09 相当のエラーとして「位置情報サービスをオンにしてください」というダイアログを表示する。権限が拒否された場合、チェックイン処理を中断し、「位置情報の許可が必要です」というトーストを表示する。9.2. 距離計算ロジック (Haversine formula実装)固定ルール 4および 要件定義書 5 に基づき、以下のコードを lib/core/utils/distance_calculator.dart に実装する。Dartimport 'dart:math';

class DistanceCalculator {
  /// 2地点間の距離を計算(Haversine formula) [cite: 40]
  ///
  /// @param lat1 地点1の緯度
  /// @param lon1 地点1の経度
  /// @param lat2 地点2の緯度
  /// @param lon2 地点2の経度
  /// @return 距離(メートル)
  static double calculate(
    double lat1,
    double lon1,
    double lat2,
    double lon2,
  ) {
    const double earthRadius = 6371000; // 地球の半径(メートル) [cite: 41]

    double dLat = _toRadians(lat2 - lat1);
    double dLon = _toRadians(lon2 - lon1);
    double radLat1 = _toRadians(lat1);
    double radLat2 = _toRadians(lat2);

    double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(radLat1) * cos(radLat2) * sin(dLon / 2) * sin(dLon / 2);
    double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    double distance = earthRadius * c;

    return distance;
  }

  /// 度をラジアンに変換
  static double _toRadians(double degrees) {
    return degrees * pi / 180; [cite: 42]
  }

  /// 指定された距離(閾値)以内かどうかを判定
  static bool isWithinRange(
    double lat1,
    double lon1,
    double lat2,
    double lon2,
    double threshold, // 閾値(メートル)
  ) {
    double distance = calculate(lat1, lon1, lat2, lon2);
    return distance <= threshold;
  }
}
9.3. チェックイン判定フロー (F-USR-008)ユーザーが SCR-USR-005 (試合詳細画面) で「チェックイン」ボタンをタップする。クライアント (Flutter) が F-USR-008 API (POST /api/v1/games/{gameId}/checkin) を呼び出す。サーバー (Laravel) の CheckinRequest がリクエストを受領。【サーバー側バリデーション】a.  AuthService が、認証済みユーザーがこの試合に参加登録しているか（participations テーブルに user_id と game_id のレコードが存在するか）確認。* NG (未参加): HTTP 400 (E-400-08: この試合に参加登録していません) 6 を返す。b.  CheckinService が、該当の参加ステータス（participations.status）を確認。* NG (チェックイン済): HTTP 409 (E-409-04: 既にチェックイン済みです) 7 を返す。c.  CheckinService が、現在時刻と試合開始時刻（games.game_date_time）を比較。* NG (時間外): HTTP 400 (E-400-09: チェックイン可能時間外です) 8 を返す。（※時間帯制御は 9.4 を参照）クライアント (Flutter) が geolocator を使用して現在の位置情報（緯度・経度）を取得する。（※9.1 の権限要求フローを経る）クライアントが取得した緯度・経度を、F-USR-008 API のリクエストボディに含めてサーバーに送信する。JSON{
  "latitude": 35.689614,
  "longitude": 139.691648
}
【サーバー側バリデーション（位置）】a.  CheckinService が、リクエストされた緯度・経度と、試合会場の緯度・経度（games.latitude, games.longitude）を DistanceCalculator (Haversine formula) 9 を用いて比較。b.  計算した距離が、試合の許容半径（games.acceptable_radius）を超えるか判定。* NG (範囲外): HTTP 400 (E-400-10: 会場から{distance}メートル離れています) 10 を返す。【DB更新処理】a.  トランザクション開始b.  ParticipationRepository が participations テーブルの該当レコードの status カラムを '参加確定' から 'チェックイン済' 11 にUPDATEする。c.  トランザクションコミットサーバーが HTTP 200 (成功) を返す。クライアントは成功レスポンスを受け、SCR-USR-005 (試合詳細画面) のボタンを「チェックイン済み」に変更し、トーストを表示する。9.4. 時間帯制御定義: エラーメッセージ定義書.csv 12 に基づき、チェックイン可能な時間は 試合開始2時間前 ? 試合終了時刻 とする。実装: CheckinService (Laravel) 内で以下のロジックを実装する。game.game_date_time を取得。checkin_start_time = game_date_time - 2 hourscheckin_end_time = game_date_time + 3 hours （※試合の標準時間を3時間と仮定。games テーブルに終了時刻カラムがないため）NOW() が checkin_start_time と checkin_end_time の間にあるか判定する。詳細設計への共通コンテキスト（第9章）後続タスク（詳細設計）への指示:Flutter実装:「9.1. 位置情報取得方式」に基づき、geolocator を使用した位置情報取得と権限要求のロジックを、SCR-USR-005（試合詳細画面）の Provider または Service に実装してください。「9.2. 距離計算ロジック」の DistanceCalculator.dart ファイルを lib/core/utils/ 配下に作成・実装してください。「9.3. チェックイン判定フロー」のクライアント側処理（API呼び出し、ローディング表示、成功/エラーハンドリング）を実装してください。Laravel実装:F-USR-008 API (/api/v1/games/{gameId}/checkin) に対応する CheckinController, CheckinService, CheckinRequest を作成してください。CheckinService に「9.3. チェックイン判定フロー」のサーバー側バリデーション（ステップ4, 7）とDB更新処理（ステップ8）を実装してください。「9.4. 時間帯制御」のロジックを CheckinService に実装してください。DistanceCalculator のロジック（Haversine formula 13）をPHPで app/Utils/ 配下に実装し、CheckinService から呼び出せるようにしてください。第10章 通知・メール設計10.1. 通知種別一覧本システムは、以下の通知（プッシュ通知・メール）を定義する。プッシュ通知: 7種類（要件定義書 14）メール: 7種類（要件定義書 15）10.2. プッシュ通知テンプレート完全定義（要件定義書 16の例に基づき、固定ルール 17（高優先度/通常優先度）を適用して7種類を定義）通知IDタイトル本文トリガー優先度対象ユーザーPUSH-001試合登録完了「{place_name}」の試合を登録しました。 18管理者が試合登録時 (F-ADM-006)通常登録した管理者PUSH-002参加登録完了「{place_name}」への参加登録が完了しました。ユーザーが試合参加登録時 (F-USR-006)通常参加したユーザーPUSH-003試合リマインダーまもなく試合開始です。「{place_name}」 ( {game_date_time} )試合開始1時間前 (バッチ処理)高 19該当試合の全参加者PUSH-004試合中止のお知らせ「{place_name}」 ( {game_date_time} ) の試合は中止になりました。管理者が試合ステータスを「中止」に変更時高該当試合の全参加者PUSH-005試合満員のお知らせ「{place_name}」は満員になりました。試合ステータスが「満員」に変更時通常該当試合の全参加者PUSH-006チェックイン完了「{place_name}」へのチェックインが完了しました。ユーザーがチェックイン時 (F-USR-008)通常チェックインしたユーザーPUSH-007運営からのお知らせ{title}管理者が一括通知配信時 (F-ADM-009)高管理者が指定した対象者10.3. メールテンプレート完全定義（要件定義書 20の例に基づき、HTML形式で7種類を定義。固定ルール 21 に従いプレーンテキストのフォールバックも用意する前提）MAIL-001: アカウント登録完了 22件名: 【草野球マッチング】アカウント登録完了トリガー: F-USR-001 (アカウント登録時)対象: 登録したユーザー本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>アカウント登録完了</title></head>
<body>
  <h2>アカウント登録完了</h2>
  <p>{nickname}様</p>
  <p>草野球マッチングアプリへのご登録ありがとうございます。</p>
  <p>以下のニックネームで登録が完了しました。<br>
     ニックネーム: {nickname}</p>
  <p>アプリを開いて試合を探しましょう！</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
MAIL-002: パスワードリセット要求件名: 【草野球マッチング】パスワードリセットのご案内トリガー: F-USR-004 (パスワードリセット要求時)対象: リクエストしたユーザー本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>パスワードリセット</title></head>
<body>
  <h2>パスワードリセットのご案内</h2>
  <p>{nickname}様</p>
  <p>パスワードリセットのリクエストを受け付けました。</p>
  <p>以下のリンクをクリックして、パスワードの再設定を完了してください。<br>
     このリンクの有効期限は60分です。</p>
  <p><a href="{reset_url}">パスワードをリセットする</a></p>
  <p>リンク（アプリで開く場合）: {reset_url}</p>
  <hr>
  <p>※本メールアドレスにお心当たりのない場合、本メールは破棄してください。</p>
</body>
</html>
MAIL-003: パスワードリセット完了件名: 【草野球マッチング】パスワードリセット完了のお知らせトリガー: F-USR-004 (パスワードリセット実行時)対象: リクエストしたユーザー本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>パスワードリセット完了</title></head>
<body>
  <h2>パスワードリセット完了</h2>
  <p>{nickname}様</p>
  <p>パスワードの再設定が正常に完了しました。</p>
  <p>新しいパスワードでアプリにログインしてください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
MAIL-004: 試合参加登録完了件名: 【草野球マッチング】試合参加登録完了のお知らせトリガー: F-USR-006 (試合参加登録時)対象: 参加したユーザー本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>試合参加登録完了</title></head>
<body>
  <h2>試合参加登録完了</h2>
  <p>{nickname}様</p>
  <p>以下の試合への参加登録が完了しました。</p>
  <p>
    <strong>試合:</strong> {place_name}<br>
    <strong>日時:</strong> {game_date_time}<br>
    <strong>住所:</strong> {address}<br>
    <strong>参加費:</strong> {fee}円<br>
  </p>
  <p>当日は「チェックイン」機能を利用するため、アプリを忘れずにお持ちください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
MAIL-005: 試合中止のお知らせ件名: 【草野球マッチング】試合中止のお知らせトリガー: 管理者が試合ステータスを「中止」に変更時対象: 該当試合の全参加者本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>試合中止のお知らせ</title></head>
<body>
  <h2>試合中止のお知らせ</h2>
  <p>{nickname}様</p>
  <p>ご参加予定でした以下の試合は、主催者の都合（または天候不良）により中止となりました。</p>
  <p>
    <strong>試合:</strong> {place_name}<br>
    <strong>日時:</strong> {game_date_time}<br>
  </p>
  <p>ご迷惑をおかけいたしますが、何卒ご了承ください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
MAIL-006: 強制退会通知件名: 【草野球マッチング】アカウント停止のお知らせトリガー: F-ADM-003 (ユーザー強制退会時)対象: 退会させられたユーザー本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>アカウント停止のお知らせ</title></head>
<body>
  <h2>アカウント停止のお知らせ</h2>
  <p>{nickname}様</p>
  <p>あなたがご利用の草野球マッチングアプリのアカウントは、利用規約への違反が確認されたため、運営により停止（強制退会）されました。</p>
  <p>本決定に伴い、今後の本サービスのご利用はできません。</p>
  <p>何卒ご了承ください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
MAIL-007: 管理者向け一括配信件名: 【草野球マッチング】{title}トリガー: F-ADM-010 (メール配信時)対象: 管理者が指定した対象者本文 (HTML):HTML<!DOCTYPE html>
<html>
<head><title>{title}</title></head>
<body>
  <p>{nickname}様</p>
  <p>
    {body}
  </p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
詳細設計への共通コンテキスト（第10章）後続タスク（詳細設計）への指示:Laravel実装 (Mailable):「10.3. メールテンプレート完全定義」に基づき、7種類の Mailable クラス（例: AccountRegistered.php, PasswordReset.php など）を app/Mail/ に実装してください。対応する Blade テンプレート（例: account_registered.blade.php）を resources/views/emails/ に作成してください。各サービスクラス（AuthService, GameServiceなど）から、該当するトリガー（例: アカウント登録時）で Mail::queue() を呼び出す処理を実装してください。Laravel実装 (Notification):「10.2. プッシュ通知テンプレート完全定義」に基づき、7種類の Notification クラス（例: GameReminder.php, GameCancelled.php など）を app/Notifications/ に実装してください。各通知クラスに viaFCM() メソッドを実装し、FCMに送信するペイロード（タイトル、本文）を定義してください。該当するトリガー（例: バッチ処理、サービス）から User::notify() を呼び出す処理を実装してください。第9章と第10章は以上となります。