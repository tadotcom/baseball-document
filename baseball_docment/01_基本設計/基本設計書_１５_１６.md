第15章 テスト方針詳細非機能要件（カバレッジ80%以上） 2 および コーディング規約（命名規則）に基づき、以下のテスト方針を定義する。15.1. 単体テスト (Laravel / PHPUnit)目的: Service層のビジネスロジック、Repository層のデータアクセスロジックが個別に正しく動作することを確認する。対象: app/Services/、app/Repositories/ 配下の全クラス。方針:Repository層のテストでは、インメモリDB (SQLite) または DBトランザクション を使用し、実DBとの接続を検証する。Service層のテストでは、依存する Repository層 をモック化（Mockery）し、ビジネスロジックの分岐（IF文）を網羅する。テストケース例 (GameServiceTest.php)テストクラステストメソッドテスト内容期待結果GameServiceTesttest_create_game_with_valid_data()正常なデータで試合登録処理を呼び出す<ul><li>GameRepository::create が1回呼び出される。</li><li>Game オブジェクトが返却される。</li></ul>GameServiceTesttest_create_game_throws_exception_on_db_error()GameRepository::create が例外をスローするようモック化ServiceException がスローされるGameServiceTesttest_checkin_successfully()F-USR-008（チェックイン）の正常系ロジック<ul><li>ParticipationRepository::updateStatus が呼び出される。</li><li>status が 'チェックイン済' になる。</li></ul>GameServiceTesttest_checkin_fails_if_already_checked_in()F-USR-008 異常系（重複）AlreadyCheckedInException がスローされるGameServiceTesttest_checkin_fails_if_outside_time_window()F-USR-008 異常系（時間外）CheckinTimeWindowException がスローされるGameServiceTesttest_checkin_fails_if_outside_radius()F-USR-008 異常系（距離）CheckinRadiusException がスローされる15.2. 単体テスト (Flutter / flutter_test)目的: Provider (Riverpod) の状態管理ロジック、Utilクラス（距離計算など）が個別に正しく動作することを確認する。対象: lib/features/*/application/ (Notifier)、lib/core/utils/ 配下のクラス。方針:ProviderContainer を使用して Provider をテストする。APIを呼び出す Repository はモック化（Mockito）し、Provider が API のレスポンス（成功/失敗）に応じて状態（AsyncLoading, AsyncData, AsyncError）を正しく遷移させるか確認する。テストケース例 (distance_calculator_test.dart)テストファイルテスト内容期待結果distance_calculator_test.dart2地点間（東京駅-新宿駅）の距離計算期待される距離（約X.Xkm）がメートル単位で返却されるdistance_calculator_test.dartisWithinRange 閾値内 (500m)true が返却されるdistance_calculator_test.dartisWithinRange 閾値外 (1000m)false が返却されるauth_provider_test.dartlogin 正常系<ul><li>AuthRepository::login が呼び出される。</li><li>TokenStorageService::saveToken が呼び出される。</li><li>状態が AsyncData になる。</li></ul>auth_provider_test.dartlogin 異常系 (401エラー)<ul><li>AuthRepository::login が例外をスロー。</li><li>TokenStorageService は呼び出されない。</li><li>状態が AsyncError になる。</li></ul>15.3. 統合テスト (Laravel / Pest, HTTP Tests)目的: APIエンドポイント（Controller層）が、Service, Repository, DB と連携し、仕様通りのレスポンス（JSON構造、ステータスコード）を返すか確認する。対象: 第5章で定義した全APIエンドポイント。方針: Laravel の HTTPテスト機能（$this->getJson(), $this->postJson()）を使用し、DBをリフレッシュしながらAPIを実叩きする。テストケース例エンドポイントテストケース期待結果 (HTTPステータス / JSON)POST /api/v1/auth/register正常系 (F-USR-001)201 / data.token が存在するPOST /api/v1/auth/register異常系 (Email重複 E-409-01)409 / error.code が 'E-409-01'POST /api/v1/auth/register異常系 (Nickname 4文字でない E-422-07)422 / error.details[0].field が 'nickname'GET /api/v1/games正常系 (認証済み)200 / data が配列、meta.total が存在するGET /api/v1/games異常系 (未認証 E-401-01)401POST /api/v1/games/{id}/checkin異常系 (管理者権限で実行 E-403-01)403 / error.code が 'E-403-01'15.4. E2Eテスト (Flutter / Patrol, Integration Test)目的: ユーザーの主要な操作フロー（スプラッシュ画面からチェックイン完了まで）が、実機（またはエミュレータ）上で正常に動作することを確認する。対象: 第6章で定義した主要画面遷移シナリオ。方針: E2Eテストフレームワーク (Patrol) を使用し、実際のWidgetをタップ、入力、スクロール操作してテストする。シナリオ例シナリオIDシナリオ名ステップ期待結果E2E-001新規登録とログイン1. アプリ起動
2. [新規登録] タップ
3. 有効な情報を入力し [登録] タップ
4. [設定] タップ
5. [ログアウト] タップ
6. 登録した情報で [ログイン] タップ1. ログイン画面表示
2. 登録画面表示
3. 試合一覧画面(SCR-USR-004) に遷移
4. 設定画面(SCR-USR-007) に遷移
5. ログイン画面表示
6. 試合一覧画面に遷移E2E-002試合参加とチェックイン1. (E2E-001 ログイン済み)
2. 試合一覧で特定の試合をタップ
3. [参加登録] タップ
4. チーム・ポジションを選択し [登録] タップ
5. [チェックイン] タップ (※モック位置)1. 試合一覧画面表示
2. 試合詳細画面(SCR-USR-005) に遷移
3. 参加登録画面(SCR-USR-006) に遷移
4. 試合詳細画面に戻り、[チェックイン] ボタンが表示
5. 「チェックインしました」トースト表示15.5. モック対象・方法外部サービス: FCM, SMTP, Google Maps (Deep Link) はモック化、またはスタブ化する。Laravel: Mail::fake(), Notification::fake() を使用。Flutter: url_launcher のモックを作成。日時: チェックイン機能（9.4. 時間帯制御）やバッチ処理（11.1.）のテストでは、Carbon (Laravel) や DateTime.now() (Flutter) をモック化し、現在時刻を固定してテストする。詳細設計への共通コンテキスト（第15章）後続タスク（詳細設計）への指示:テスト仕様書の作成:本章の「15.1」?「15.4」のテストケース例に基づき、全機能・全API・全画面シナリオ を網羅する詳細なテスト仕様書（Excel, TestRailなど）を作成してください。テスト仕様書には、テストデータ（入力値）と期待結果（DBの状態、画面表示）を具体的に記載してください。テストコードの実装:作成したテスト仕様書に基づき、PHPUnit, flutter_test, Pest, Patrol のテストコードを実装してください。非機能要件 3 であるコードカバレッジ80%以上を達成することを目標とします。CI/CDへの組み込み:「16. デプロイ設計」のCI/CDパイプラインに、これらのテスト（最低でも単体テストと統合テスト）を実行するステップを組み込んでください。第16章 デプロイ設計16.1. デプロイフロー開発者が develop ブランチから main ブランチ（または release ブランチ）へプルリクエストを作成。コードレビューと承認。main ブランチにマージ。CI/CDパイプライン（GitHub Actionsなど）が自動的にトリガーされる。CI (テスト):a.  PHPStan (静的解析), PHP CS Fixer (コード規約) を実行。b.  PHPUnit (単体テスト), Pest (統合テスト) を実行。CD (ビルド・デプロイ):a.  (Laravel) composer install --no-dev 等のビルドコマンド実行。b.  (Laravel) SSH経由で Xserver VPS に接続。c.  (Laravel) メンテナンスモードを有効化 (php artisan down)。d.  (Laravel) git pull, composer install, php artisan migrate --force 等のデプロイコマンドを実行（16.3参照）。e.  (Laravel) メンテナンスモードを解除 (php artisan up)。(Flutter) Flutter のビルド（iOS/Android）は手動、またはCI/CD（Codemagicなど）で行い、各ストア（App Store Connect, Google Play Console）にアップロードする。16.2. CI/CDパイプライン概要ツール: GitHub Actions (想定)トリガー: main ブランチへの push主要ステップ (抜粋):YAMLjobs:
  test_laravel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        # (PHP, Composerのセットアップ)
      - name: Install Dependencies
        run: composer install
      - name: Run PHPStan
        run: ./vendor/bin/phpstan analyse
      - name: Run Tests
        run: php artisan test

  deploy_laravel:
    needs: test_laravel
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/grass-baseball-matching
            # (16.3. のデプロイコマンド一覧を実行)
16.3. 環境構築手順詳細Nginx設定ファイル/etc/nginx/sites-available/grass-baseball-matching （要件定義書の固定ルール 4 に基づく完全版）Nginxserver {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com;
    
    # SSL対応とhttp2の警告を回避するため、.well-knownのみ許可し他はHTTPSへリダイレクト
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt;
        allow all;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com;
    root /var/www/grass-baseball-matching/public; # Laravelのpublicディレクトリ [cite: 54]
    index index.php index.html index.htm;

    # SSL証明書設定 (Let's Encrypt等)
    ssl_certificate /path/to/ssl/fullchain.pem;
    ssl_certificate_key /path/to/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        # Xserver VPS の PHP-FPM ソケットパス
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock; 
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # .env や .git へのアクセス拒否
    location ~ /\. {
        deny all;
    }
}
Laravelデプロイコマンド一覧（CI/CDの script: または手動デプロイで実行するコマンド 5）Bash# 1. メンテナンスモード有効化
php artisan down

# 2. リポジトリから最新コードを取得
git pull origin main

# 3. Composer インストール (本番用)
composer install --no-dev --optimize-autoloader

# 4. データベースマイグレーション実行
# (本番環境では --force が必要)
php artisan migrate --force

# 5. キャッシュのクリアと再作成
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 6. (オプション) キューワーカーの再起動
php artisan queue:restart

# 7. メンテナンスモード解除
php artisan up
Flutterビルド・デプロイコマンド6iOS (App Store Connect)Bash# 1. 依存パッケージインストール
cd flutter_app
flutter pub get

# 2. (オプション) クリーン
flutter clean

# 3. リリースビルド (IPAファイル作成)
flutter build ipa --release --export-options-plist=ExportOptions.plist

# 4. (オプション) Xcode Cloud または Transporter.app を使用してアップロード
# または fastlane を使用
# fastlane deliver
Android (Google Play Console)Bash# 1. 依存パッケージインストール
cd flutter_app
flutter pub get

# 2. (オプション) クリーン
flutter clean

# 3. リリースビルド (App Bundle作成)
# (署名設定は build.gradle で行う)
flutter build appbundle --release

# 4. (オプション) fastlane を使用してアップロード
# fastlane supply
16.4. 環境変数一覧 (.envファイルの全項目)（要件定義書の固定ルール 7 に基づく完全版）Bash# アプリケーション基本設定
APP_NAME="GrassBaseballMatching"
APP_ENV=production
APP_KEY=base64:xxxxx # (php artisan key:generate で生成)
APP_DEBUG=false
APP_URL=https://yourdomain.com

# ログ設定
LOG_CHANNEL=daily
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=info

# データベース設定 (Xserver VPS)
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=grass_baseball_matching
DB_USERNAME=db_user
DB_PASSWORD=secure_password

# キャッシュ/セッション/キュー
BROADCAST_DRIVER=log
CACHE_DRIVER=file
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database # (非同期処理のため sync 以外を推奨)
SESSION_DRIVER=file
SESSION_LIFETIME=120

# SMTP (メール送信) 設定 (Xserver)
MAIL_MAILER=smtp
MAIL_HOST=your-xserver-smtp-host.com
MAIL_PORT=587
MAIL_USERNAME=your-smtp-username
MAIL_PASSWORD=your-smtp-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="support@yourdomain.com"
MAIL_FROM_NAME="${APP_NAME}"

# Sanctum (認証) 設定
SANCTUM_STATEFUL_DOMAINS=yourdomain.com # (Web管理画面用)

# FCM (Firebase) 設定
# (FirebaseサービスアカウントのJSONキーパス)
FCM_SERVER_KEY=AAAA...
FCM_SENDER_ID=...
詳細設計への共通コンテキスト（第16章）後続タスク（詳細設計）への指示:CI/CDパイプラインの実装:「16.2. CI/CDパイプライン概要」に基づき、GitHub Actions のtest_laravel.yml と deploy_laravel.ymlワークフローファイルを具体的に実装してください。secrets（SSHキー、VPSホスト名、.envファイルの内容）をGitHubリポジトリに安全に登録してください。Flutterビルド環境の構築:iOS/Androidのビルドに必要な署名ファイル（Keystore, ProvisioningProfile）を安全に管理する方法（GitHub Secrets, fastlane matchなど）を確立してください。環境構築手順書の作成:「16.3. Nginx設定ファイル」「16.4. 環境変数一覧」に基づき、新しい Xserver VPSをゼロから構築するための詳細な「環境構築手順書」を作成してください。手順書には、PHP, Composer, Nginx, MySQL, Gitのインストールと設定、SSL証明書（Let's Encrypt）の取得手順を含めてください。デプロイ手順書の作成:「16.3. デプロイコマンド一覧」に基づき、手動デプロイ（緊急時）および自動デプロイ（CI/CD）の「デプロイ手順書」を整備してください。第15章と第16章は以上となります。（残りは第17章、第18章、第19章です。）