# 第15章 パフォーマンス設計

## 15.1 パフォーマンス要件

### レスポンスタイム目標

| 操作 | 目標レスポンスタイム | 備考 |
|---|---|---|
| API (単一リソース取得) | 200ms以内 | 例: 試合詳細取得 |
| API (一覧取得) | 500ms以内 | 例: 試合一覧取得 (20件/ページ) |
| API (登録・更新) | 300ms以内 | 例: アカウント登録、試合参加登録 |
| 画面遷移 (Flutter) | 100ms以内 | スプラッシュ画面からログイン画面など |
| 画面描画 (Flutter) | 60fps維持 | スムーズなスクロール、アニメーション |

### 同時接続数

- **想定ユーザー数:** 1,000人
- **ピーク時同時接続数:** 100接続

### データベース

- **クエリ実行時間:** 50ms以内（インデックス適用済み）
- **接続プール:** 最大20接続

## 15.2 データベース最適化

### インデックス設計

適切なインデックスを設定し、クエリパフォーマンスを向上させる。

#### users テーブル

```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_nickname ON users(nickname);
```

#### games テーブル

```sql
CREATE INDEX idx_games_game_date_time ON games(game_date_time);
CREATE INDEX idx_games_status ON games(status);
CREATE INDEX idx_games_status_game_date_time ON games(status, game_date_time);
```

#### participations テーブル

```sql
CREATE INDEX idx_participations_user_id ON participations(user_id);
CREATE INDEX idx_participations_game_id ON participations(game_id);
CREATE INDEX idx_participations_user_game ON participations(user_id, game_id);
```

#### device_tokens テーブル

```sql
CREATE INDEX idx_device_tokens_user_id ON participations(user_id);
CREATE UNIQUE INDEX idx_device_tokens_unique ON device_tokens(user_id, device_token);
```

### N+1問題の回避

Eloquent の Eager Loading を使用してN+1問題を回避する。

**悪い例 (N+1問題):**

```php
$games = Game::all();

foreach ($games as $game) {
    echo $game->user->name;  // ここで毎回クエリが実行される
}
```

**良い例 (Eager Loading):**

```php
$games = Game::with('user')->get();

foreach ($games as $game) {
    echo $game->user->name;  // 1回のクエリで取得済み
}
```

**試合一覧取得の最適化例:**

```php
// 試合 + 主催者 + 参加者数を1度のクエリで取得
$games = Game::with('user')
             ->withCount('participations')
             ->where('status', '募集中')
             ->paginate(20);
```

## 15.3 キャッシュ戦略

### キャッシュ対象

頻繁にアクセスされ、かつ更新頻度が低いデータをキャッシュする。

| データ | キャッシュキー | TTL (有効期限) | 更新タイミング |
|---|---|---|---|
| 試合一覧 (募集中) | `games:list:recruiting` | 5分 | 試合登録・更新・削除時に無効化 |
| 試合詳細 | `games:detail:{game_id}` | 10分 | 試合更新・削除時に無効化 |
| ユーザー詳細 | `users:detail:{user_id}` | 30分 | ユーザー情報更新時に無効化 |

### Redis 設定

**キャッシュドライバー:** Redis

**設定ファイル:** `config/cache.php`

```php
'default' => env('CACHE_DRIVER', 'redis'),

'stores' => [
    'redis' => [
        'driver' => 'redis',
        'connection' => 'cache',
        'lock_connection' => 'default',
    ],
],
```

### キャッシュ実装例

**試合一覧取得でのキャッシュ利用:**

```php
use Illuminate\Support\Facades\Cache;

public function getGameList()
{
    return Cache::remember('games:list:recruiting', 300, function () {
        return Game::with('user')
                   ->withCount('participations')
                   ->where('status', '募集中')
                   ->orderBy('game_date_time', 'asc')
                   ->paginate(20);
    });
}
```

**試合更新時のキャッシュ無効化:**

```php
public function updateGame($gameId, $data)
{
    $game = Game::findOrFail($gameId);
    $game->update($data);

    // キャッシュを無効化
    Cache::forget('games:list:recruiting');
    Cache::forget("games:detail:{$gameId}");

    return $game;
}
```

## 15.4 API レートリミット

固定ルールに基づき、以下のレートリミットを設定する。

### レートリミット設定

| エンドポイント | 制限 | 備考 |
|---|---|---|
| 認証必須API (全般) | 120回/分 | ユーザーごと |
| ログインAPI | 5回/分 | IPアドレスごと (ブルートフォース攻撃対策) |

### Laravel実装

**ファイル:** `app/Providers/RouteServiceProvider.php`

```php
<?php

namespace App\Providers;

use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Foundation\Support\Providers\RouteServiceProvider as ServiceProvider;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;
use Illuminate\Support\Facades\Route;

class RouteServiceProvider extends ServiceProvider
{
    /**
     * Define your route model bindings, pattern filters, and other route configuration.
     */
    public function boot(): void
    {
        // 認証必須API: 120回/分 (ユーザーごと)
        RateLimiter::for('api', function (Request $request) {
            return Limit::perMinute(120)->by($request->user()?->id ?: $request->ip());
        });

        // ログインAPI: 5回/分 (IPアドレスごと)
        RateLimiter::for('login', function (Request $request) {
            return Limit::perMinute(5)->by($request->ip());
        });

        $this->routes(function () {
            Route::middleware('api')
                ->prefix('api')
                ->group(base_path('routes/api.php'));

            Route::middleware('web')
                ->group(base_path('routes/web.php'));
        });
    }
}
```

**routes/api.php での適用:**

```php
// ログインAPI (レート制限: 5回/分)
Route::middleware('throttle:login')->group(function () {
    Route::post('/v1/auth/login', [AuthController::class, 'login']);
});

// 認証必須API (レート制限: 120回/分)
Route::middleware(['auth:sanctum', 'throttle:api'])->group(function () {
    Route::get('/v1/games', [GameController::class, 'index']);
    Route::get('/v1/games/{gameId}', [GameController::class, 'show']);
    // ...
});
```

### レート制限超過時のレスポンス

```json
{
  "error": {
    "code": "E-429-01",
    "message": "リクエスト制限を超えました。しばらくしてから再度お試しください。"
  },
  "meta": {
    "timestamp": "2025-10-24T02:15:00Z"
  }
}
```

## 15.5 画像最適化

### アップロード制限

- **最大ファイルサイズ:** 5MB
- **許可形式:** JPEG, PNG
- **推奨解像度:** 1920x1080 以下

### サーバー側での画像リサイズ

**採用ライブラリ:** Intervention Image

**インストール:**

```bash
composer require intervention/image
```

**実装例:**

```php
use Intervention\Image\Facades\Image;

public function uploadGameImage(Request $request)
{
    $image = $request->file('image');
    
    // 画像をリサイズ (最大幅: 1200px, アスペクト比維持)
    $resized = Image::make($image)
                    ->resize(1200, null, function ($constraint) {
                        $constraint->aspectRatio();
                        $constraint->upsize();
                    })
                    ->encode('jpg', 80);  // JPEG品質: 80%

    // ストレージに保存
    $filename = uniqid() . '.jpg';
    Storage::disk('public')->put("games/{$filename}", $resized);

    return Storage::url("games/{$filename}");
}
```

### CDN利用

画像や静的ファイルはCDN（例: CloudFlare、AWS CloudFront）を経由して配信することで、サーバー負荷を軽減し、レスポンスタイムを改善する。

---

# 第16章 デプロイ・インフラ設計

## 16.1 システム構成図

```
┌─────────────────────┐
│   Flutter App       │
│  (iOS / Android)    │
└──────────┬──────────┘
           │ HTTPS
           ▼
┌─────────────────────┐
│   Xserver VPS       │
│  ┌───────────────┐  │
│  │   Nginx       │  │
│  │  (Webserver)  │  │
│  └───────┬───────┘  │
│          │          │
│  ┌───────▼───────┐  │
│  │   Laravel     │  │
│  │  (PHP 8.2)    │  │
│  └───────┬───────┘  │
│          │          │
│  ┌───────▼───────┐  │
│  │   MySQL 8.0   │  │
│  └───────────────┘  │
│                     │
│  ┌───────────────┐  │
│  │   Redis       │  │
│  └───────────────┘  │
└─────────────────────┘
           │
           ▼
┌─────────────────────┐
│  Firebase Cloud     │
│  Messaging (FCM)    │
└─────────────────────┘
```

## 16.2 サーバースペック

### Xserver VPS 推奨プラン

**プラン:** 2GB以上

**スペック:**

- **CPU:** 3コア
- **メモリ:** 2GB
- **ストレージ:** 50GB SSD
- **OS:** Ubuntu 24.04 LTS

### ミドルウェアバージョン

- **Nginx:** 1.24以上
- **PHP:** 8.2
- **MySQL:** 8.0
- **Redis:** 7.0以上
- **Composer:** 2.x
- **Node.js:** 20.x (ビルド用)

## 16.3 Nginx 設定ファイル

**ファイル:** `/etc/nginx/sites-available/grassballapp`

```nginx
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$host$request_uri;  # HTTPからHTTPSへリダイレクト
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    root /var/www/grassballapp/public;

    index index.php index.html index.htm;

    # SSL証明書 (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ログ
    access_log /var/log/nginx/grassballapp_access.log;
    error_log /var/log/nginx/grassballapp_error.log;

    # PHP処理
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # 静的ファイルのキャッシュ
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # .htaccessなどの隠しファイルへのアクセス拒否
    location ~ /\. {
        deny all;
    }
}
```

## 16.4 MySQL 設定

**ファイル:** `/etc/mysql/my.cnf`

```ini
[mysqld]
# 文字コード
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 接続設定
max_connections = 100
connect_timeout = 10

# パフォーマンス
innodb_buffer_pool_size = 512M  # メモリの50%程度
innodb_log_file_size = 128M

# スロークエリログ
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2

[client]
default-character-set = utf8mb4
```

## 16.5 デプロイ手順

### 初回デプロイ

#### 1. サーバーへの接続

```bash
ssh root@your-server-ip
```

#### 2. 必要なパッケージのインストール

```bash
# システム更新
apt update && apt upgrade -y

# Nginx
apt install nginx -y

# PHP 8.2
apt install software-properties-common -y
add-apt-repository ppa:ondrej/php -y
apt update
apt install php8.2-fpm php8.2-mysql php8.2-xml php8.2-curl php8.2-mbstring php8.2-zip php8.2-gd php8.2-redis -y

# MySQL
apt install mysql-server -y

# Redis
apt install redis-server -y

# Composer
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
```

#### 3. Laravelプロジェクトのデプロイ

```bash
# プロジェクトディレクトリを作成
mkdir -p /var/www/grassballapp
cd /var/www/grassballapp

# Gitからクローン
git clone https://github.com/your-repo/grassballapp.git .

# Composer依存関係のインストール
composer install --no-dev --optimize-autoloader

# .envファイルの設定
cp .env.example .env
nano .env  # 環境変数を設定

# アプリケーションキーの生成
php artisan key:generate

# データベースマイグレーション
php artisan migrate --force

# ストレージリンク
php artisan storage:link

# パーミッション設定
chown -R www-data:www-data /var/www/grassballapp
chmod -R 755 /var/www/grassballapp
chmod -R 775 /var/www/grassballapp/storage
chmod -R 775 /var/www/grassballapp/bootstrap/cache
```

#### 4. SSL証明書の取得 (Let's Encrypt)

```bash
apt install certbot python3-certbot-nginx -y
certbot --nginx -d yourdomain.com
```

#### 5. Nginx設定とサービス起動

```bash
# Nginx設定ファイルをコピー
cp /var/www/grassballapp/nginx.conf /etc/nginx/sites-available/grassballapp
ln -s /etc/nginx/sites-available/grassballapp /etc/nginx/sites-enabled/

# Nginx設定テスト
nginx -t

# Nginxを再起動
systemctl restart nginx

# PHP-FPMを起動
systemctl start php8.2-fpm
systemctl enable php8.2-fpm
```

#### 6. Cronの設定

```bash
crontab -e
```

追加する行:

```
* * * * * cd /var/www/grassballapp && php artisan schedule:run >> /dev/null 2>&1
```

### 継続的デプロイ

#### GitHub Actionsでの自動デプロイ

**ファイル:** `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/grassballapp
            git pull origin main
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            systemctl restart php8.2-fpm
```

## 16.6 バックアップ戦略

### データベースバックアップ

**バックアップスクリプト:** `/root/backup_db.sh`

```bash
#!/bin/bash

# バックアップディレクトリ
BACKUP_DIR="/var/backups/mysql"
DATE=$(date +"%Y%m%d_%H%M%S")

# データベースをバックアップ
mysqldump -u root -p'your_password' grassballapp > ${BACKUP_DIR}/grassballapp_${DATE}.sql

# 14日以上古いバックアップを削除
find ${BACKUP_DIR} -name "grassballapp_*.sql" -mtime +14 -delete

echo "Backup completed: grassballapp_${DATE}.sql"
```

**Cron設定 (毎日3時にバックアップ):**

```bash
0 3 * * * /root/backup_db.sh
```

### ファイルバックアップ

アップロードされた画像など、`storage/app/public` の内容を定期的にバックアップする。

```bash
#!/bin/bash

# バックアップディレクトリ
BACKUP_DIR="/var/backups/storage"
DATE=$(date +"%Y%m%d")

# storageをバックアップ
tar -czf ${BACKUP_DIR}/storage_${DATE}.tar.gz /var/www/grassballapp/storage/app/public

# 14日以上古いバックアップを削除
find ${BACKUP_DIR} -name "storage_*.tar.gz" -mtime +14 -delete

echo "Storage backup completed: storage_${DATE}.tar.gz"
```

### 詳細設計への共通コンテキスト（第16章）

**後続タスク（詳細設計）への指示:**

#### インフラ構築手順書の作成

「16.5. デプロイ手順」に基づき、より詳細なインフラ構築手順書（ステップバイステップ）を作成してください。

特にセキュリティ設定（ファイアウォール、SSH設定、MySQL root パスワード設定など）を明確に記載してください。

#### 監視設定

サーバーの稼働状況を監視するツール（例: Prometheus + Grafana、Zabbix）を導入し、以下の指標を監視できるようにしてください:

- CPU使用率
- メモリ使用率
- ディスク使用率
- Nginx / PHP-FPM のプロセス数
- MySQLのスロークエリ数

---

**第15章と第16章は以上となります。**
