# 第9章 位置情報・チェックイン機能設計

## 9.1 位置情報取得方式 (Flutter)

### 採用パッケージ

**geolocator**

### 要求精度

**LocationAccuracy.high** （高精度GPS）

### 権限要求フロー

1. ユーザーが初めて「チェックイン」ボタン（SCR-USR-005 試合詳細画面）をタップした際に、位置情報利用の許可を要求する
2. `geolocator` の `checkPermission()` で現在のステータスを確認
3. ステータスが `denied` の場合、`requestPermission()` を呼び出し、OSの許可ダイアログを表示する
4. ステータスが `deniedForever` （永続的に拒否）の場合、アプリの設定画面へ誘導するダイアログを表示する
5. ステータスが `granted` の場合のみ、`getCurrentPosition()` を呼び出して位置情報を取得する

### エラーハンドリング

- **位置情報サービス（GPS）が無効の場合:**  
  E-400-09 相当のエラーとして「位置情報サービスをオンにしてください」というダイアログを表示する

- **権限が拒否された場合:**  
  チェックイン処理を中断し、「位置情報の許可が必要です」というトーストを表示する

## 9.2 距離計算ロジック (Haversine formula実装)

固定ルールおよび要件定義書に基づき、以下のコードを `lib/core/utils/distance_calculator.dart` に実装する。

```dart
import 'dart:math';

class DistanceCalculator {
  /// 2地点間の距離を計算(Haversine formula)
  ///
  /// @param lat1 地点1の緯度
  /// @param lon1 地点1の経度
  /// @param lat2 地点2の緯度
  /// @param lon2 地点2の経度
  /// @return 距離(メートル)
  static double calculate(
    double lat1,
    double lon1,
    double lat2,
    double lon2,
  ) {
    const double earthRadius = 6371000; // 地球の半径(メートル)

    double dLat = _toRadians(lat2 - lat1);
    double dLon = _toRadians(lon2 - lon1);
    double radLat1 = _toRadians(lat1);
    double radLat2 = _toRadians(lat2);

    double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(radLat1) * cos(radLat2) * sin(dLon / 2) * sin(dLon / 2);
    double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    double distance = earthRadius * c;

    return distance;
  }

  /// 度をラジアンに変換
  static double _toRadians(double degrees) {
    return degrees * pi / 180;
  }

  /// 指定された距離(閾値)以内かどうかを判定
  static bool isWithinRange(
    double lat1,
    double lon1,
    double lat2,
    double lon2,
    double threshold, // 閾値(メートル)
  ) {
    double distance = calculate(lat1, lon1, lat2, lon2);
    return distance <= threshold;
  }
}
```

## 9.3 チェックイン判定フロー (F-USR-008)

1. ユーザーが SCR-USR-005 (試合詳細画面) で「チェックイン」ボタンをタップする
2. クライアント (Flutter) が F-USR-008 API (`POST /api/v1/games/{gameId}/checkin`) を呼び出す
3. サーバー (Laravel) の `CheckinRequest` がリクエストを受理

### サーバー側バリデーション

#### a. 参加登録チェック

`AuthService` が、認証済みユーザーがこの試合に参加登録しているか（`participations` テーブルに `user_id` と `game_id` のレコードが存在するか）確認

- **NG (未参加):** HTTP 400 (E-400-08: この試合に参加登録していません) を返す

#### b. チェックイン状態確認

`CheckinService` が、該当の参加ステータス（`participations.status`）を確認

- **NG (チェックイン済):** HTTP 409 (E-409-04: 既にチェックイン済みです) を返す

#### c. 時間範囲確認

`CheckinService` が、現在時刻と試合開始時刻（`games.game_date_time`）を比較

- **NG (時間外):** HTTP 400 (E-400-09: チェックイン可能時間外です) を返す
- (※時間帯制御は 9.4 を参照)

### 位置情報取得と送信

4. クライアント (Flutter) が `geolocator` を使用して現在の位置情報（緯度・経度）を取得する（※9.1の権限要求フローを経る）
5. クライアントが取得した緯度・経度を、F-USR-008 API のリクエストボディに含めてサーバーに送信する

```json
{
  "latitude": 35.689614,
  "longitude": 139.691648
}
```

### サーバー側距離判定

6. サーバー (Laravel) の `CheckinService` が以下を実行:
   - `games` テーブルから試合会場の緯度経度 (`latitude`, `longitude`) を取得
   - Haversine formula を使用して、ユーザーの現在地と試合会場の距離を計算
   - 距離が **500メートル以内** の場合のみチェックイン成功
   
**NG (範囲外):** HTTP 400 (E-400-10: 試合会場から離れているためチェックインできません) を返す

7. (成功時) サーバーは以下を実行:
   - `participations` テーブルの該当レコードの `status` を「チェックイン済み」に更新
   - `checked_in_at` カラムに現在時刻を記録
   - HTTP 200でチェックイン成功レスポンスを返却

```json
{
  "data": {
    "participation_id": "uuid",
    "status": "checked_in",
    "checked_in_at": "2025-10-24T10:00:00Z"
  },
  "meta": {
    "timestamp": "2025-10-24T10:00:05Z"
  }
}
```

8. クライアントは成功メッセージ（トースト）を表示し、試合詳細画面の「チェックイン」ボタンを非活性化する

## 9.4 チェックイン可能時間帯

固定ルールに基づき、以下の時間帯のみチェックイン可能とする:

- **試合開始時刻の1時間前から、試合開始時刻まで**

**例:**

- 試合開始時刻: 2025-10-24 14:00
- チェックイン可能時間帯: 2025-10-24 13:00 ~ 14:00

**実装 (Laravel):**

```php
$gameDateTime = Carbon::parse($game->game_date_time);
$now = Carbon::now();

$checkinStart = $gameDateTime->copy()->subHour(); // 1時間前
$checkinEnd = $gameDateTime; // 試合開始時刻

if ($now->lt($checkinStart) || $now->gt($checkinEnd)) {
    throw new ValidationException('E-400-09: チェックイン可能時間外です');
}
```

---

# 第10章 通知機能設計

## 10.1 通知種別と送信タイミング

| 通知種別 | 送信タイミング | 送信方法 | 対応機能ID |
|---|---|---|---|
| アカウント登録完了 | ユーザー登録直後 | メール | F-USR-001 |
| パスワードリセット | パスワードリセット要求時 | メール | F-USR-004 |
| 試合参加登録完了 | 参加登録直後 | プッシュ通知 + メール | F-USR-006 |
| 試合開催前日リマインダー | 試合開催24時間前 | プッシュ通知 + メール | バッチ処理 |
| 試合中止のお知らせ | 管理者が試合ステータスを「中止」に変更時 | プッシュ通知 + メール | F-ADM-007 |
| 強制退会通知 | 管理者がユーザーを強制退会時 | メール | F-ADM-003 |
| 管理者向け一斉配信 | 管理者が任意に配信 | プッシュ通知 or メール | F-ADM-009, F-ADM-010 |

## 10.2 プッシュ通知テンプレート完全定義

### PUSH-001: 試合参加登録完了

**タイトル:** 参加登録完了

**本文:**

```
{place_name}の試合への参加登録が完了しました。
日時: {game_date_time}
```

**データペイロード:**

```json
{
  "type": "game_registered",
  "game_id": "{game_id}"
}
```

**トリガー:** F-USR-006 (試合参加登録) 成功時

**対象:** 参加登録したユーザー

### PUSH-002: 試合開催前日リマインダー

**タイトル:** 明日は試合です！

**本文:**

```
明日、{place_name}で試合があります。
日時: {game_date_time}
忘れずにチェックインしてください。
```

**データペイロード:**

```json
{
  "type": "game_reminder",
  "game_id": "{game_id}"
}
```

**トリガー:** バッチ処理（毎日0時に翌日の試合を検索し、該当する試合の全参加者に送信）

**対象:** 該当試合の全参加者

### PUSH-003: 試合中止のお知らせ

**タイトル:** 試合中止のお知らせ

**本文:**

```
{place_name}の試合は中止となりました。
日時: {game_date_time}
```

**データペイロード:**

```json
{
  "type": "game_cancelled",
  "game_id": "{game_id}"
}
```

**トリガー:** 管理者が試合ステータスを「中止」に変更時

**対象:** 該当試合の全参加者

### PUSH-004: 管理者向け一斉配信

**タイトル:** {title} (管理者が入力)

**本文:** {body} (管理者が入力)

**データペイロード:**

```json
{
  "type": "admin_broadcast",
  "notification_id": "{notification_id}"
}
```

**トリガー:** F-ADM-009 (プッシュ通知配信) 実行時

**対象:** 管理者が指定した対象者

## 10.3 メールテンプレート完全定義

### MAIL-001: アカウント登録完了

**件名:** 【草野球マッチング】アカウント登録完了

**トリガー:** F-USR-001 (アカウント登録) 成功時

**対象:** 登録したユーザー

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>アカウント登録完了</title></head>
<body>
  <h2>ようこそ、{nickname}様</h2>
  <p>草野球マッチングへのご登録ありがとうございます。</p>
  <p>アプリをダウンロードして、さっそく試合を探しましょう！</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-002: パスワードリセット

**件名:** 【草野球マッチング】パスワードリセットのご案内

**トリガー:** F-USR-004 (パスワードリセット要求) 実行時

**対象:** リセット要求したユーザー

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>パスワードリセット</title></head>
<body>
  <h2>パスワードリセットのご案内</h2>
  <p>{nickname}様</p>
  <p>パスワードリセットのリクエストを受け付けました。</p>
  <p>以下のリンクからパスワードを再設定してください。</p>
  <p><a href="{reset_link}">パスワードを再設定する</a></p>
  <p>※このリンクは24時間有効です。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-003: 試合参加登録完了

**件名:** 【草野球マッチング】試合参加登録完了

**トリガー:** F-USR-006 (試合参加登録) 成功時

**対象:** 参加登録したユーザー

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>試合参加登録完了</title></head>
<body>
  <h2>試合参加登録完了</h2>
  <p>{nickname}様</p>
  <p>以下の試合への参加登録が完了しました。</p>
  <p>
    <strong>試合:</strong> {place_name}<br>
    <strong>日時:</strong> {game_date_time}<br>
    <strong>住所:</strong> {address}<br>
    <strong>チーム:</strong> {team}<br>
    <strong>ポジション:</strong> {position}<br>
  </p>
  <p>当日は「チェックイン」機能を利用してください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-004: 試合開催前日リマインダー

**件名:** 【草野球マッチング】明日は試合です

**トリガー:** バッチ処理（毎日0時）

**対象:** 翌日の試合の全参加者

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>試合開催前日リマインダー</title></head>
<body>
  <h2>明日は試合です！</h2>
  <p>{nickname}様</p>
  <p>明日、以下の試合があります。</p>
  <p>
    <strong>試合:</strong> {place_name}<br>
    <strong>日時:</strong> {game_date_time}<br>
    <strong>住所:</strong> {address}<br>
    <strong>参加費:</strong> {fee}円<br>
  </p>
  <p>当日は「チェックイン」機能を利用するため、アプリを忘れずにお持ちください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-005: 試合中止のお知らせ

**件名:** 【草野球マッチング】試合中止のお知らせ

**トリガー:** 管理者が試合ステータスを「中止」に変更時

**対象:** 該当試合の全参加者

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>試合中止のお知らせ</title></head>
<body>
  <h2>試合中止のお知らせ</h2>
  <p>{nickname}様</p>
  <p>ご参加予定でした以下の試合は、主催者の都合（または天候不良）により中止となりました。</p>
  <p>
    <strong>試合:</strong> {place_name}<br>
    <strong>日時:</strong> {game_date_time}<br>
  </p>
  <p>ご迷惑をおかけいたしますが、何卒ご了承ください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-006: 強制退会通知

**件名:** 【草野球マッチング】アカウント停止のお知らせ

**トリガー:** F-ADM-003 (ユーザー強制退会)

**対象:** 退会させられたユーザー

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>アカウント停止のお知らせ</title></head>
<body>
  <h2>アカウント停止のお知らせ</h2>
  <p>{nickname}様</p>
  <p>あなたがご利用の草野球マッチングアプリのアカウントは、利用規約への違反が確認されたため、運営により停止（強制退会）されました。</p>
  <p>本決定に伴い、今後の本サービスのご利用はできません。</p>
  <p>何卒ご了承ください。</p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### MAIL-007: 管理者向け一斉配信

**件名:** 【草野球マッチング】{title}

**トリガー:** F-ADM-010 (メール配信時)

**対象:** 管理者が指定した対象者

**本文 (HTML):**

```html
<!DOCTYPE html>
<html>
<head><title>{title}</title></head>
<body>
  <p>{nickname}様</p>
  <p>
    {body}
  </p>
  <hr>
  <p>※本メールは送信専用です。</p>
</body>
</html>
```

### 詳細設計への共通コンテキスト（第10章）

**後続タスク（詳細設計）への指示:**

#### Laravel実装 (Mailable)

「10.3. メールテンプレート完全定義」に基づき、7種類の Mailable クラス（例: AccountRegistered.php, PasswordReset.php など）を `app/Mail/` に実装してください。

対応する Blade テンプレート（例: account_registered.blade.php）を `resources/views/emails/` に作成してください。

各サービスクラス（AuthService, GameServiceなど）から、該当するトリガー（例: アカウント登録時）で `Mail::queue()` を呼び出す処理を実装してください。

#### Laravel実装 (Notification)

「10.2. プッシュ通知テンプレート完全定義」に基づき、7種類の Notification クラス（例: GameReminder.php, GameCancelled.php など）を `app/Notifications/` に実装してください。

各通知クラスに `viaFCM()` メソッドを実装し、FCMに送信するペイロード（タイトル、本文）を定義してください。

該当するトリガー（例: バッチ処理、サービス）から `User::notify()` を呼び出す処理を実装してください。

---

**第9章と第10章は以上となります。**
