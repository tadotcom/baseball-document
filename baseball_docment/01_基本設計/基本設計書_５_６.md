第5章 API設計5.1. API設計方針アーキテクチャ: RESTful API 1命名規則:エンドポイント: リソース（名詞の複数形）ベース。バージョンプレフィックス /api/v1 を付与 2。パスパラメータ: gameId, userId のようにキャメルケースを使用 3。リクエスト/レスポンス: JSONキーはスネークケース（例: user_id, game_date_time）バージョニング: URLにバージョン情報（v1）を含める 4。5.2. 認証・認可方式認証方式: Laravel Sanctum （固定ルール） 5トークン種別: Personal Access Token (PAT) 6トークン伝達: HTTPリクエストヘッダー Authorization: Bearer {token} 7トークンのライフタイム: 24時間 （固定ルール） 8リフレッシュトークン: 使用しない 9。有効期限切れ時はHTTP 401エラーを返し、クライアント側で再ログインを要求する。認可方式:Laravel Middleware を使用して認証チェック (auth:sanctum) 10。管理者機能（/api/v1/admin/*）は、追加の AdminMiddleware を使用し、管理者権限（例: users テーブルの role カラムなど、※要件定義になかったため仮設定）をチェックする。5.3. APIエンドポイント一覧表（固定ルール に基づく全18機能 + デバイストークン登録）エンドポイントHTTPメソッド機能概要認証要否対応する機能ID/api/v1/auth/registerPOSTアカウント登録不要F-USR-001/api/v1/auth/loginPOSTログイン不要F-USR-002/api/v1/auth/logoutPOSTログアウト必要F-USR-003/api/v1/auth/password/resetPOSTパスワードリセット要求不要F-USR-004/api/v1/auth/password/updatePUTパスワードリセット実行不要F-USR-004/api/v1/gamesGET試合一覧取得必要F-USR-005/api/v1/games/{gameId}GET試合詳細取得必要F-USR-007/api/v1/gamesPOST試合登録必要 (管理)F-ADM-006/api/v1/games/{gameId}PUT試合更新必要 (管理)F-ADM-007/api/v1/games/{gameId}DELETE試合削除必要 (管理)F-ADM-008/api/v1/games/{gameId}/participationsPOST試合参加登録必要F-USR-006/api/v1/games/{gameId}/checkinPOSTチェックイン必要F-USR-008/api/v1/admin/usersGETユーザー一覧取得必要 (管理)F-ADM-001/api/v1/admin/users/{userId}GETユーザー詳細取得必要 (管理)F-ADM-002/api/v1/admin/users/{userId}DELETEユーザー強制退会必要 (管理)F-ADM-003/api/v1/admin/gamesGET管理者用試合一覧取得必要 (管理)F-ADM-004/api/v1/admin/games/{gameId}GET管理者用試合詳細取得必要 (管理)F-ADM-005/api/v1/admin/notifications/pushPOSTプッシュ通知配信必要 (管理)F-ADM-009/api/v1/admin/notifications/emailPOSTメール配信必要 (管理)F-ADM-010/api/v1/device-tokensPOSTデバイストークン登録必要(該当なし)5.4. リクエスト/レスポンス仕様 (全18APIの完全定義)【本章の前提条件】要件定義書 には「全18機能のAPIについて、以下のフォーマットで詳細を記載してください」 との指示があります。第3章 と同様に、まず「F-USR-001: アカウント登録機能」を具体例として作成します。他のAPIについても、後続の詳細設計フェーズでこのフォーマットに従ってすべて定義する必要があります。テンプレート 11[HTTPメソッド] [エンドポイント] - [機能ID]概要: (機能の概要)認証: (要否)リクエストヘッダーContent-Type: application/json
Authorization: Bearer {token}  # 認証必須の場合
リクエストボディ (該当する場合)JSON{
  "field1": "type(説明)",
  "field2": "type(説明)"
}
レスポンス (成功時 2xx)JSON{
  "data": {
    // 具体的なフィールドを記載
  },
  "meta": {
    "timestamp": "2025-10-24T02:15:00Z"
  }
}
レスポンス (エラー時 4xx/5xx) (※ 5.5. エラーレスポンス統一仕様 を参照)HTTPステータスコード200: 成功 (取得・更新)201: 成功 (作成)204: 成功 (削除・内容なし)400: リクエストエラー (E-400-xx)401: 認証エラー (E-401-xx)403: 権限エラー (E-403-xx)404: リソース未検出 (E-404-xx)409: 競合エラー (E-409-xx)422: バリデーションエラー (E-422-xx)500: サーバーエラー (E-500-xx)API定義の具体例 (F-USR-001)POST /api/v1/auth/register - F-USR-001概要: 新規ユーザーのアカウントを登録する。認証: 不要リクエストヘッダーContent-Type: application/json
リクエストボディJSON{
  "email": "string(メールアドレス)",
  "password": "string(パスワード 8~72文字)",
  "password_confirmation": "string(パスワード確認)",
  "nickname": "string(ニックネーム 4文字固定)"
}
レスポンス (成功時 201 Created)JSON{
  "data": {
    "user": {
      "user_id": "c3e9c7f6-1f3a-4b9c-8e4a-5a6b7c8d9e0f",
      "email": "user@example.com",
      "nickname": "たろう"
    },
    "token": "1|abcdefghijklmnopqrstuvwxyz123456"
  },
  "meta": {
    "timestamp": "2025-10-24T02:15:00Z"
  }
}
HTTPステータスコード201: 成功 (作成)400: リクエストエラー (E-400-01)409: 競合エラー (E-409-01, E-409-02)422: バリデーションエラー (E-422-04, 05, 06, 07, 08)500: サーバーエラー (E-500-03)5.5. エラーレスポンス統一仕様固定ルール に従い、全てのエラーレスポンスは以下のJSONフォーマットで統一する。JSON{
  "error": {
    "code": "E-XXX-XX",
    "message": "エラーメッセージ",
    "details": [
      {
        "field": "email",
        "message": "メールアドレスの形式が正しくありません"
      }
    ]
  },
  "meta": {
    "timestamp": "2025-10-24T02:15:00Z"
  }
}
error.code: エラーメッセージ定義書.csv 12 に記載された固有のエラーコード。error.message: エラーメッセージ定義書.csv 13 に記載された日本語メッセージ。error.details: バリデーションエラー（422）の場合に、どのフィールドがどのような理由でエラーになったかを示す配列。meta.timestamp: サーバーがレスポンスを生成した時刻 (ISO 8601)。エラーコード完全一覧表（エラーメッセージ定義書.csv 14 の内容を本設計書の一部として取り込む。後続の詳細設計で、必要に応じて追加定義する）エラーコードHTTPステータスメッセージ（日本語）発生条件対応機能IDE-400-01400リクエストが不正ですJSON形式エラー・必須パラメータ欠落全機能E-400-02400ユーザーIDの形式が正しくありませんUUID形式でないF-ADM-002/F-ADM-003...............E-401-01401認証に失敗しましたトークンが無効または期限切れ全認証必須機能E-401-02401メールアドレスまたはパスワードが正しくありません認証失敗F-USR-002...............E-403-01403管理者権限が必要です管理者権限がないF-ADM-001?010...............E-404-01404ユーザーが見つかりませんユーザーが存在しないF-ADM-002/F-ADM-003E-404-02404試合が見つかりません試合が存在しないF-USR-006?008/F-ADM-005?008...............E-409-01409このメールアドレスは既に登録されていますメールアドレス重複F-USR-001E-409-02409このニックネームは既に使用されていますニックネーム重複F-USR-001E-409-03409既にこの試合に参加登録しています重複参加F-USR-006E-409-04409既にチェックイン済みです重複チェックインF-USR-008...............E-422-01422開催日時は現在時刻の1時間後以降を指定してくださいgame_date_timeが不正F-ADM-006/F-ADM-007...............E-500-01500通知の配信に失敗しましたFCMエラーF-ADM-009E-500-02500メールの配信に失敗しましたSMTPエラーF-ADM-010E-500-03500サーバーエラーが発生しました予期しないエラー全機能5.6. ページネーション仕様固定ルール 15 に従い、一覧取得系API（F-USR-005, F-ADM-001, F-ADM-004）はオフセットベースのページネーションを実装する。方式: オフセットベース 16リクエストパラメータ:page: ページ番号 (デフォルト: 1) 17per_page: 1ページあたりの件数 (デフォルト: 20, 最大: 100) 18レスポンス構造 (固定フォーマット): 19JSON{
  "data": [
    { /* リソースの配列 */ }
  ],
  "meta": {
    "current_page": 1,
    "per_page": 20,
    "total": 100,
    "last_page": 5,
    "timestamp": "2025-10-24T02:15:00Z"
  }
}
5.7. CORS設定固定ルール 20 に従い、Laravel側でCORSを設定する。許可オリジン (production): yourdomain.com （本番環境のドメインのみ）許可オリジン (development): *許可メソッド: GET, POST, PUT, DELETE, OPTIONS 21許可ヘッダー: Content-Type, Authorization, Accept 22認証情報 (Credentials): true （SanctumのCookie認証（Web管理画面用）とトークン認証を共存させるため） 23詳細設計への共通コンテキスト（第5章）後続タスク（詳細設計）への指示:API仕様書の完成:本章の「5.4. リクエスト/レスポンス仕様」テンプレート を使用し、一覧表に記載された全API の仕様を定義してください。バリデーションルールは、第3章 で定義した「固定バリデーションルール」 24と、各機能の「エラー処理」 25 を参照して正確に記述してください。コントローラーの設計:定義したAPIエンドポイントに基づき、Laravelの routes/api.php を定義してください。各エンドポイントに対応する Controller クラス（例: GameController.php）とメソッド（例: index(), show(), store(), update(), destroy()）を設計してください。FormRequestの設計:リクエストボディを持つAPI（POST, PUT）については、対応する FormRequest クラス（例: StoreGameRequest.php）を設計し、バリデーションルールとエラーメッセージを定義してください。第6章 画面設計6.1. 画面一覧表（要件定義書 26 および ワイヤーフレームテンプレート に基づく）画面ID画面名画面概要対応する機能IDユーザー向け (Flutter)SCR-USR-001ログイン画面メールアドレスとパスワードでログインするF-USR-002SCR-USR-002アカウント登録画面新規アカウントを登録するF-USR-001SCR-USR-003パスワードリセット画面パスワードの再設定を要求・実行するF-USR-004SCR-USR-004試合一覧画面開催予定の試合を一覧表示・検索するF-USR-005SCR-USR-005試合詳細画面試合の詳細情報を表示するF-USR-007SCR-USR-006参加登録画面試合への参加登録（チーム・ポジション選択）を行うF-USR-006SCR-USR-007設定画面ログアウトなどを行うF-USR-003(SCR-USR-008)(チェックイン処理)(画面なし。SCR-USR-005内のボタン操作)F-USR-008管理者向け (Web)SCR-ADM-001管理者ログイン画面管理者がログインする(F-USR-002相当)SCR-ADM-002ダッシュボード画面統計情報や最近の試合を表示するSCR-ADM-003ユーザー一覧画面登録ユーザーを一覧表示するF-ADM-001SCR-ADM-004ユーザー詳細画面ユーザーの詳細情報を表示するF-ADM-002, F-ADM-003SCR-ADM-005試合一覧画面(管理者用)全ての試合を一覧表示するF-ADM-004SCR-ADM-006試合登録/編集画面試合の新規登録または更新を行うF-ADM-006, F-ADM-007SCR-ADM-007試合詳細画面(管理者用)試合の詳細情報を表示するF-ADM-005SCR-ADM-008通知配信画面プッシュ通知やメールを配信するF-ADM-009, F-ADM-0106.2. 画面遷移図 (完全版)ユーザー向け画面遷移 27コード スニペットgraph TD
    A[スプラッシュ画面] --> B{ログイン状態}
    B -->|未ログイン| C[SCR-USR-001<br/>ログイン画面]
    B -->|ログイン済み| D[SCR-USR-004<br/>試合一覧画面]
    C -->|新規登録| E[SCR-USR-002<br/>アカウント登録画面]
    C -->|パスワード忘れ| F[SCR-USR-003<br/>パスワードリセット画面]
    C -->|ログイン成功| D
    E -->|登録完了| D
    D -->|試合タップ| G[SCR-USR-005<br/>試合詳細画面]
    G -->|参加登録| I[SCR-USR-006<br/>参加登録画面]
    I -->|登録完了| G
    G -->|チェックイン処理| J(F-USR-008<br/>チェックインAPI実行)
    J -->|成功/失敗| G
    D -->|メニュー/設定| K[SCR-USR-007<br/>設定画面]
    K -->|ログアウト| C
管理者向け画面遷移 28コード スニペットgraph TD
    A[SCR-ADM-001<br/>管理者ログイン画面] -->|ログイン成功| B[SCR-ADM-002<br/>ダッシュボード画面]
    B -->|ユーザー管理| C[SCR-ADM-003<br/>ユーザー一覧画面]
    C -->|詳細| D[SCR-ADM-004<br/>ユーザー詳細画面]
    B -->|試合管理| E[SCR-ADM-005<br/>試合一覧画面]
    E -->|新規登録| F[SCR-ADM-006<br/>試合登録/編集画面]
    E -->|編集| F
    E -->|詳細| H[SCR-ADM-007<br/>試合詳細画面]
    B -->|通知管理| I[SCR-ADM-008<br/>通知配信画面]
6.3. 各画面の詳細設計 (全画面必須)【本章の前提条件】要件定義書 29 および 画面ワイヤーフレームテンプレート.md に基づき、全画面の詳細設計を定義します。まず「SCR-USR-001: ログイン画面」を具体例として作成します。他の全画面（ユーザー向け・管理者向け）についても、後続の詳細設計フェーズでこのフォーマットに従ってすべて定義する必要があります。ユーザー向け画面 (Flutter)SCR-USR-001: ログイン画面対応機能ID: F-USR-002ワイヤーフレーム: (画面ワイヤーフレームテンプレート.md 参照)┌─────────────────────────────────┐
│ ← ログイン               　　　　│ 
├─────────────────────────────────┤
│                                 │
│          [ロゴ画像]              │ 
│        草野球マッチング           │ 
│                                 │
│  ┌─────────────────────────┐   │
│  │ ? メールアドレス          │   │ 
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ ? パスワード             │   │ 
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │      ログイン              │   │ 
│  └─────────────────────────┘   │
│                                 │
│     パスワードをお忘れですか?      │ 
│                                 │
│  ─────────────────────────────  │
│                                 │
│  アカウントをお持ちでないですか?   │ 
│         [新規登録]               │ 
│                                 │
└─────────────────────────────────┘
画面項目定義 (表形式)項目名Widget型必須/任意バリデーション (固定ルール)備考メールアドレスTextFormField必須形式: RFC 5322準拠 30keyboardType: TextInputType.emailAddressパスワードTextFormField必須最小長: 8文字, 最大長: 72文字 31obscureText: trueログインボタンElevatedButton--押下時 F-USR-002 API実行パスワード忘れTextButton--SCR-USR-003 へ遷移新規登録TextButton--SCR-USR-002 へ遷移レイアウト構成 (画面ワイヤーフレームテンプレート.md のデザインガイドライン準拠)ScaffoldappBar: AppBar (タイトル: 'ログイン')body: SingleChildScrollView + Padding (水平16px)Column (中央揃え)Image (ロゴ)Text ('草野球マッチング', H1スタイル)SizedBox (高さ 32px)TextFormField (メールアドレス)SizedBox (高さ 16px)TextFormField (パスワード)SizedBox (高さ 24px)ElevatedButton (ログイン, プライマリボタン)TextButton (パスワードをお忘れですか?)SpacerRow (中央揃え)Text ('アカウントをお持ちでないですか?')TextButton ('新規登録')状態管理 (Riverpod)loginProvider (AsyncNotifierProvider): ログイン処理の状態（AsyncValue）を管理。状態: AsyncLoading (ローディング中), AsyncError (エラー発生), AsyncData (成功)loginButtonStateProvider (StateProvider<bool>): フォームの入力状況（メール・パスワードが空でない）を監視し、ログインボタンの活性/非活性を管理。操作フローユーザーが「メールアドレス」「パスワード」を入力する。両方のフィールドが入力されると、loginButtonStateProvider が true になり、「ログインボタン」が活性化する。ユーザーが「ログインボタン」をタップする。loginProvider が AsyncLoading 状態になり、画面中央にローディングスピナー（CircularProgressIndicator）を表示する。loginProvider が F-USR-002 API (/api/v1/auth/login) を呼び出す。(成功時) APIからトークンが返却される。a.  トークンを flutter_secure_storage に保存する。b.  SCR-USR-004 (試合一覧画面) に遷移する。(失敗時: 401) loginProvider が AsyncError 状態になる。a.  エラーメッセージ (E-401-02: メールアドレスまたはパスワードが正しくありません) 32 をトースト（SnackBar）で表示する。(失敗時: 422) loginProvider が AsyncError 状態になる。a.  インラインエラー（TextFormField の decoration.errorText）にエラーメッセージ (E-422-04, 05) を表示する。エラー表示 (固定ルール 33 準拠)トースト/スナックバー: 認証失敗時 (E-401-02) 34ダイアログ: サーバーエラー時 (E-500-03) 35インラインエラー: バリデーションエラー時 (E-422-04, 05) 36詳細設計への共通コンテキスト（第6章）後続タスク（詳細設計）への指示:画面設計書の完成:本章の「6.3. 各画面の詳細設計」テンプレート を使用し、「6.1. 画面一覧表」 に記載された全画面 の詳細設計を完成させてください。ワイヤーフレームの作成: 画面ワイヤーフレームテンプレート.md を参考に、未定義の画面（特に管理者画面）のワイヤーフレームを定義してください。状態管理（Riverpod）の設計:各画面の「状態管理」セクションで、必要な Provider を具体的に定義してください（例: gameListProvider, gameDetailProviderなど）。各 Provider がどのAPI（第5章）を呼び出し、どのような状態（ローディング、エラー、データ）を管理するかを明確にしてください。コンポーネント設計:画面ワイヤーフレームテンプレート.md の「GameCard コンポーネント」 のように、複数画面で再利用するWidget（例: PrimaryButton, GameCard）は、lib/shared/widgets/ 配下に配置するものとして別途設計してください。第5章と第6章は以上となります。（第7章 セキュリティ設計 以降も、固定ルールと要件定義書に基づき、詳細な定義が可能です。）