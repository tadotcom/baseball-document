# 第17章 監視・運用設計

## 17.1 監視項目

### サーバー監視

| 監視項目 | 閾値 | アラート条件 | 対応アクション |
|---|---|---|---|
| CPU使用率 | 80%以上 | 5分間継続 | プロセス調査・スケールアップ検討 |
| メモリ使用率 | 85%以上 | 5分間継続 | メモリリーク調査・再起動 |
| ディスク使用率 | 80%以上 | - | 不要ファイル削除・ディスク拡張 |
| Nginxプロセス | 停止 | - | サービス再起動 |
| PHP-FPMプロセス | 停止 | - | サービス再起動 |
| MySQLプロセス | 停止 | - | サービス再起動 |

### アプリケーション監視

| 監視項目 | 閾値 | アラート条件 | 対応アクション |
|---|---|---|---|
| APIエラー率 (500系) | 5%以上 | 10分間継続 | ログ確認・原因調査 |
| APIレスポンスタイム | 1秒以上 | 平均値が10分間継続 | クエリ最適化・キャッシュ見直し |
| 連続ログイン失敗 | 10回以上/分 | 同一IP | IPブロック・アラート |
| バッチ処理失敗 | 1回 | - | ログ確認・手動実行 |

### データベース監視

| 監視項目 | 閾値 | アラート条件 | 対応アクション |
|---|---|---|---|
| スロークエリ数 | 10件以上/時 | - | クエリ最適化・インデックス追加 |
| 接続数 | 80以上 | - | 接続プール設定見直し |
| レプリケーション遅延 | 10秒以上 | - | レプリケーション再構築 |

## 17.2 ログ運用

### ログ保存期間

| ログ種別 | 保存期間 | ローテーション |
|---|---|---|
| Nginxアクセスログ | 30日 | 日次 |
| Nginxエラーログ | 30日 | 日次 |
| Laravelアプリケーションログ | 14日 | 日次 |
| MySQLスロークエリログ | 7日 | 日次 |

### ログ確認手順

#### Laravelアプリケーションログ

```bash
# 最新のログを確認
tail -f /var/www/grassballapp/storage/logs/laravel.log

# 特定の日付のログを確認
cat /var/www/grassballapp/storage/logs/laravel-2025-10-24.log

# エラーログのみ抽出
grep ERROR /var/www/grassballapp/storage/logs/laravel.log
```

#### Nginxログ

```bash
# アクセスログ
tail -f /var/log/nginx/grassballapp_access.log

# エラーログ
tail -f /var/log/nginx/grassballapp_error.log

# 500エラーのみ抽出
grep " 500 " /var/log/nginx/grassballapp_access.log
```

#### MySQLスロークエリログ

```bash
# スロークエリログ
tail -f /var/log/mysql/slow-query.log

# pt-query-digestで解析 (Percona Toolkitが必要)
pt-query-digest /var/log/mysql/slow-query.log
```

## 17.3 障害対応フロー

### 障害検知

1. 監視ツール（Zabbix、Prometheusなど）からアラートを受信
2. 管理者がSlack/メールでアラートを確認

### 初動対応

3. サーバーにSSH接続してステータス確認

```bash
# サービス状態確認
systemctl status nginx
systemctl status php8.2-fpm
systemctl status mysql

# リソース使用状況確認
top
df -h
free -m
```

4. ログ確認（17.2参照）

### 復旧作業

5. サービス再起動（必要に応じて）

```bash
systemctl restart nginx
systemctl restart php8.2-fpm
systemctl restart mysql
```

6. キャッシュクリア

```bash
cd /var/www/grassballapp
php artisan cache:clear
php artisan config:clear
php artisan route:clear
```

7. 復旧確認

```bash
# APIヘルスチェック
curl https://yourdomain.com/api/health

# Nginxログで正常アクセスを確認
tail /var/log/nginx/grassballapp_access.log
```

### 事後対応

8. 障害報告書の作成（原因・対応内容・再発防止策）
9. 必要に応じて恒久対策の実施

## 17.4 定期メンテナンス

### 月次作業

| 作業内容 | 実施タイミング | 作業内容詳細 |
|---|---|---|
| バックアップ確認 | 毎月1日 | データベースバックアップの復元テスト |
| ログ分析 | 毎月5日 | エラーログ・スロークエリログの分析 |
| セキュリティアップデート | 毎月10日 | OS・ミドルウェア・ライブラリの更新 |
| ディスク容量確認 | 毎月15日 | 不要ファイルの削除 |

### セキュリティアップデート手順

```bash
# システムパッケージ更新
apt update
apt upgrade -y

# Composer依存関係の更新
cd /var/www/grassballapp
composer update --no-dev

# セキュリティ脆弱性チェック
composer audit

# サービス再起動
systemctl restart nginx
systemctl restart php8.2-fpm
```

---

# 第18章 セキュリティ運用

## 18.1 アクセス制御

### SSH接続制限

- **公開鍵認証のみ許可**（パスワード認証は無効化）
- **root ログイン禁止**
- **許可IPアドレスのみ接続可能**（ファイアウォール設定）

**設定ファイル:** `/etc/ssh/sshd_config`

```
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers your-admin-user
```

### ファイアウォール設定 (UFW)

```bash
# UFWを有効化
ufw enable

# SSH (22番ポート) を許可
ufw allow 22/tcp

# HTTP (80番ポート) を許可
ufw allow 80/tcp

# HTTPS (443番ポート) を許可
ufw allow 443/tcp

# その他のポートはすべて拒否 (デフォルト)
ufw default deny incoming
ufw default allow outgoing

# 設定確認
ufw status
```

## 18.2 脆弱性診断

### 定期診断

| 診断項目 | 実施頻度 | ツール |
|---|---|---|
| Webアプリケーション脆弱性診断 | 半年ごと | OWASP ZAP、Burp Suite |
| サーバー脆弱性診断 | 半年ごと | Nessus、OpenVAS |
| 依存ライブラリ脆弱性チェック | 毎週 | `composer audit`, `npm audit` |

### 脆弱性対応フロー

1. **検出:** 脆弱性診断ツールまたは脆弱性情報サイト（CVEなど）で脆弱性を発見
2. **影響評価:** 本システムへの影響度（Critical / High / Medium / Low）を判定
3. **対応計画:** パッチ適用スケジュールを決定
   - Critical / High: 24時間以内
   - Medium: 1週間以内
   - Low: 1ヶ月以内
4. **パッチ適用:** テスト環境で動作確認後、本番環境に適用
5. **再診断:** パッチ適用後、脆弱性が解消されたことを確認

## 18.3 インシデント対応

### インシデント種別

| インシデント種別 | 例 | 優先度 |
|---|---|---|
| 不正アクセス | SQLインジェクション、XSS攻撃 | Critical |
| データ漏洩 | 個人情報の流出 | Critical |
| サービス停止 | DDoS攻撃 | High |
| 不正利用 | アカウント乗っ取り | High |

### インシデント対応フロー

#### 1. 検知

- 監視ツールのアラート
- ユーザーからの通報
- ログの異常検知

#### 2. 初動対応（Critical の場合は即座に実施）

**a. 攻撃の遮断**

```bash
# 特定IPアドレスをブロック
ufw deny from <攻撃元IP>

# 該当ユーザーのアカウントを無効化
mysql -u root -p
USE grassballapp;
UPDATE users SET status = 'suspended' WHERE id = '<ユーザーID>';
```

**b. 証拠保全**

```bash
# ログをバックアップ
cp -r /var/log/nginx /var/backups/incident_$(date +%Y%m%d)/
cp -r /var/www/grassballapp/storage/logs /var/backups/incident_$(date +%Y%m%d)/
```

#### 3. 原因調査

- アクセスログ、エラーログを詳細分析
- データベースのクエリログを確認
- 攻撃の手法を特定

#### 4. 恒久対策

- 脆弱性の修正（パッチ適用、コード修正）
- セキュリティ設定の強化
- 監視ルールの追加

#### 5. 再発防止策の実施

- セキュリティ教育の実施
- 脆弱性診断の頻度を上げる
- WAF（Web Application Firewall）の導入検討

#### 6. 報告

- 社内報告書の作成
- 必要に応じて監督官庁・ユーザーへ報告

---

# 第19章 ドキュメント管理

## 19.1 ドキュメント一覧

本システムの開発・運用に必要なドキュメントを以下に定義する。

| ドキュメント名 | 目的 | 管理場所 | 更新頻度 |
|---|---|---|---|
| 要件定義書 | システムの機能要件・非機能要件を定義 | GitHub / Confluence | 要件変更時 |
| 基本設計書 | システムアーキテクチャ・API設計・DB設計を記載 | GitHub / Confluence | 設計変更時 |
| 詳細設計書 | クラス設計・メソッド仕様を詳細に記載 | GitHub / Confluence | 実装時・変更時 |
| API仕様書 | 全APIエンドポイントの仕様を記載 | Swagger / Postman | API追加・変更時 |
| データベース設計書 | ER図・テーブル定義を記載 | GitHub / dbdocs.io | DB変更時 |
| インフラ構築手順書 | サーバー構築・デプロイ手順を記載 | GitHub | インフラ変更時 |
| 運用手順書 | 日常運用・障害対応手順を記載 | GitHub / Confluence | 運用変更時 |
| テスト仕様書 | テストケース・テスト結果を記載 | GitHub | テスト実施時 |
| リリースノート | リリース内容・変更点を記載 | GitHub Releases | リリース時 |

## 19.2 API仕様書 (Swagger)

### Swagger導入

Laravel に Swagger を導入し、APIドキュメントを自動生成する。

**パッケージインストール:**

```bash
composer require darkaonline/l5-swagger
php artisan vendor:publish --provider "L5Swagger\L5SwaggerServiceProvider"
```

### Swagger アノテーション例

**Controller にアノテーションを記述:**

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

/**
 * @OA\Info(
 *     title="草野球マッチング API",
 *     version="1.0.0"
 * )
 */
class AuthController extends Controller
{
    /**
     * @OA\Post(
     *     path="/api/v1/auth/login",
     *     summary="ログイン",
     *     tags={"認証"},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"email","password"},
     *             @OA\Property(property="email", type="string", format="email", example="user@example.com"),
     *             @OA\Property(property="password", type="string", format="password", example="password123")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="ログイン成功",
     *         @OA\JsonContent(
     *             @OA\Property(property="data", type="object",
     *                 @OA\Property(property="token", type="string", example="1|abcdefg..."),
     *                 @OA\Property(property="user", type="object",
     *                     @OA\Property(property="user_id", type="string", example="c3e9c7f6-1f3a-4b9c-8e4a-5a6b7c8d9e0f"),
     *                     @OA\Property(property="email", type="string", example="user@example.com"),
     *                     @OA\Property(property="nickname", type="string", example="たろう")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=401,
     *         description="認証失敗"
     *     )
     * )
     */
    public function login(Request $request)
    {
        // ログイン処理
    }
}
```

### Swagger ドキュメント生成

```bash
php artisan l5-swagger:generate
```

生成されたSwagger UIは以下のURLでアクセス可能:

```
https://yourdomain.com/api/documentation
```

## 19.3 データベース設計書 (dbdocs.io)

### dbdocs導入

**DBML (Database Markup Language) でER図を定義:**

**ファイル:** `database.dbml`

```dbml
Table users {
  id uuid [primary key]
  email varchar(255) [unique, not null]
  password varchar(255) [not null]
  nickname varchar(4) [unique, not null]
  created_at timestamp
  updated_at timestamp
}

Table games {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  place_name varchar(255) [not null]
  address text [not null]
  game_date_time datetime [not null]
  fee integer [not null]
  max_participants integer [not null]
  status enum [not null]
  latitude decimal(10,8)
  longitude decimal(11,8)
  created_at timestamp
  updated_at timestamp
}

Table participations {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  game_id uuid [not null, ref: > games.id]
  team enum [not null]
  position enum [not null]
  status enum [not null]
  checked_in_at datetime
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (user_id, game_id) [unique]
  }
}

Table device_tokens {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  device_token varchar(255) [not null]
  platform enum [not null]
  created_at timestamp
  updated_at timestamp
  
  indexes {
    (user_id, device_token) [unique]
  }
}
```

### dbdocs公開

```bash
# dbdocs CLIをインストール
npm install -g dbdocs

# ログイン
dbdocs login

# ドキュメントを公開
dbdocs build database.dbml
```

公開されたドキュメントは以下のようなURLでアクセス可能:

```
https://dbdocs.io/your-username/grassballapp
```

## 19.4 リリースノート

### リリースノートテンプレート

**バージョン:** v1.0.0  
**リリース日:** 2025-10-24

#### 新機能

- ユーザー登録・ログイン機能を追加
- 試合一覧・詳細表示機能を追加
- 試合参加登録機能を追加
- チェックイン機能を追加（GPS位置情報を使用）
- プッシュ通知機能を追加

#### 改善

- APIレスポンスタイムを平均200ms以内に改善
- 試合一覧のページネーション実装

#### バグ修正

- ログイン後にトークンが正しく保存されない問題を修正
- チェックイン時に距離計算が正しく行われない問題を修正

#### 既知の問題

- 管理者画面のダッシュボードが一部未実装

---

## 詳細設計への共通コンテキスト（第17~19章）

**後続タスク（詳細設計）への指示:**

### 監視設定の実装

「17.1. 監視項目」に基づき、監視ツール（Zabbix、Prometheus + Grafanaなど）を導入し、アラート設定を行ってください。

特にCritical な項目（サービス停止、500エラー多発）は即座にSlack / メール通知されるようにしてください。

### 運用手順書の作成

「17.3. 障害対応フロー」「17.4. 定期メンテナンス」に基づき、より詳細な運用手順書を作成してください。

実際に障害が発生した際に、運用担当者が迷わず対応できるレベルまで具体化してください。

### API仕様書の完成

「19.2. API仕様書 (Swagger)」に基づき、全18APIのSwaggerアノテーションを実装してください。

各APIのリクエスト・レスポンス例を含め、開発者が参照しやすいドキュメントを作成してください。

---

**第17章、第18章、第19章は以上となります。**

**本基本設計書は以上で完了です。**
