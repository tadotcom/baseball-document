詳細設計書：草野球マッチングアプリ第15章 テスト方針詳細 (詳細定義)基本設計書 第15章 の「詳細設計への共通コンテキスト」で指示されたタスク（テスト仕様書の作成、テストコードの実装、CI/CDへの組み込み）に基づき、テスト仕様を以下の通り定義する。非機能要件 であるコードカバレッジ80%以上を目標とする。15.1. 単体テスト (Laravel / PHPUnit)目的: Service層のビジネスロジック、Repository層のデータアクセスロジックの網羅的検証。方針: Service層のテストでは、Repository層をモック化（Mockery）し、ロジック分岐を検証。Repository層のテストでは、インメモリDB (SQLite) または RefreshDatabase トレイトを使用する。テストケース例 (GameServiceTest.php)テストクラステストメソッド (命名規則)テスト内容期待結果GameServiceTesttest_add_participant_successfully()F-USR-006（参加登録）正常系<ul><li>ParticipationRepository::create が1回呼び出される。</li><li>GameRepository::updateStatus（満員）が呼び出される（※満員時）。</li><li>Notification::queue が呼び出される。</li></ul>GameServiceTesttest_add_participant_fails_if_game_not_recruiting()F-USR-006 異常系（E-400-07）GameNotRecruitingException がスローされる。GameServiceTesttest_add_participant_fails_if_already_participating()F-USR-006 異常系（E-409-03）AlreadyParticipatingException がスローされる。CheckinServiceTesttest_execute_checkin_fails_if_outside_time_window()F-USR-008 異常系（E-400-09）<ul><li>Carbon::setTestNow() で現在時刻を時間外に固定。</li><li>CheckinTimeWindowException がスローされる。</li></ul>CheckinServiceTesttest_execute_checkin_fails_if_outside_radius()F-USR-008 異常系（E-400-10）<ul><li>DistanceCalculator のモックが false を返す。</li><li>CheckinRadiusException がスローされる。</li></ul>15.2. 単体テスト (Flutter / flutter_test)目的: Provider (Riverpod) の状態遷移ロジック、Utilクラスのロジック検証。方針: ProviderContainer を使用し、Repository層をモック化（Mockito）してテストする。テストケース例 (auth_provider_test.dart)テストファイルテスト内容期待結果distance_calculator_test.dartcalculate (東京駅-新宿駅)Haversine formula の期待値（メートル）が返却される。distance_calculator_test.dartisWithinRange (500m以内)true が返却される。auth_provider_test.dartlogin 正常系<ul><li>AuthRepository.login が呼び出される。</li><li>TokenStorageService.saveToken が呼び出される。</li><li>state が AsyncData になる。</li></ul>auth_provider_test.dartlogin 異常系 (401エラー)<ul><li>AuthRepository.login が例外をスロー。</li><li>state が AsyncError になる。</li></ul>game_list_provider_test.dartfetchNextPage (ページネーション)<ul><li>GameRepository.fetchGameList(page: 2) が呼び出される。</li><li>state の List<Game> が追加される。</li></ul>15.3. 統合テスト (Laravel / Pest, HTTP Tests)目的: APIエンドポイント（Controller層からDBまで）のE2Eテスト。方針: RefreshDatabase トレイトを使用し、DBをリフレッシュしながらAPIを実叩きする。テストケース例エンドポイントテストケース期待結果 (HTTPステータス / JSON)POST /api/v1/auth/register異常系 (Email重複 E-409-01)409 / error.code が 'E-409-01'POST /api/v1/auth/register異常系 (Nickname 4文字でない E-422-07)422 / error.details[0].field が 'nickname'GET /api/v1/games異常系 (未認証 E-401-01)401POST /api/v1/games異常系 (一般ユーザーで実行 E-403-01)<ul><li>Sanctum::actingAs(User::factory()->create()) で一般ユーザー認証。</li><li>403 / error.code が 'E-403-01'</li></ul>POST /api/v1/games/{id}/checkin正常系 (F-USR-008)<ul><li>時刻と位置をモック化。</li><li>200 / data.status が 'success'</li><li>DBの participations.status が 'チェックイン済' になる。</li></ul>15.4. E2Eテスト (Flutter / Patrol)目的: ユーザーの主要操作フローの実機（エミュレータ）検証。方針: E2Eテストフレームワーク (Patrol) を使用し、Widgetを操作する。シナリオ例シナリオIDシナリオ名ステップ期待結果E2E-001新規登録とログイン1. アプリ起動
2. [新規登録] タップ
3. 有効な情報を入力し [登録] タップ
4. [設定] タップ
5. [ログアウト] タップ
6. 登録した情報で [ログイン] タップ1. SCR-USR-001 表示
2. SCR-USR-002 表示
3. SCR-USR-004 (試合一覧) に遷移
4. SCR-USR-007 表示
5. SCR-USR-001 表示
6. SCR-USR-004 に遷移E2E-002試合参加とチェックイン1. (E2E-001 ログイン済み)
2. GameCard をタップ
3. [参加登録] タップ
4. チーム・ポジションを選択し [登録] タップ
5. [チェックイン] タップ (※モック位置)1. SCR-USR-004 表示
2. SCR-USR-005 に遷移
3. SCR-USR-006 に遷移
4. SCR-USR-005 に戻り、[チェックイン] ボタンが表示
5. 「チェックインしました」トースト表示15.5. モック対象 (確定)外部サービス: FCM, SMTP (Notification::fake(), Mail::fake())。日時: Carbon::setTestNow() (Laravel), clock (Flutter) を使用し、チェックイン（9.4.）やバッチ処理（11.1.）の時刻依存テストを実行。位置情報: GeolocatorPlatform (Flutter) をモック化し、固定の緯度経度を返す。15.6. コード生成AIへの共通コンテキスト (第15章)目的:第15章の定義に基づき、品質を担保するための単体テスト、統合テスト、E2Eテストのコードを実装する。指示:テスト仕様書の作成:「15.1」?「15.4」のテストケース例に基づき、全機能・全API・全ロジック分岐 を網羅する詳細なテスト仕様書（Excel, Markdownなど）を作成してください。単体テストの実装 (Laravel):tests/Unit/ 配下に、「15.1」で定義した Service クラスのテスト（CheckinServiceTest.php など）を実装してください。Mockery を使用して Repository をモック化し、expect()->method(...)->andReturn(...) で期待動作を定義してください。Carbon::setTestNow() を使用して時刻を固定し、E-400-09（時間外） のロジックをテストしてください。統合テストの実装 (Laravel):tests/Feature/ 配下に、「15.3」で定義したAPIテスト（GameApiTest.php など）を実装してください。use RefreshDatabase; トレイトを必ず使用してください。$this->postJson(...) や $this->getJson(...) を使用し、assertStatus(...) と assertJson(...) でステータスコードとエラーコード（error.code）を検証してください。Sanctum::actingAs(...) を使用して認証状態（一般ユーザー、管理者）をシミュレートしてください。単体テストの実装 (Flutter):test/ 配下に、「15.2」で定義した Provider のテスト（auth_provider_test.dart など）を実装してください。ProviderContainer と Mockito を使用し、Repository をモック化して状態遷移 (AsyncLoading, AsyncData, AsyncError) をテストしてください。CI/CDへの組み込み:第16章 で作成するCI/CDパイプライン（github/workflows/）に、php artisan test（Laravel）と flutter test（Flutter）を実行するステップを 必ず 追加してください。カバレッジ80%以上 の達成をCIのパス条件に設定してください。第16章 デプロイ設計 (詳細定義)基本設計書 第16章 の「詳細設計への共通コンテキスト」で指示されたタスク（CI/CD実装、Flutterビルド環境構築、環境構築手順書・デプロイ手順書作成）に基づき、デプロイ仕様を以下の通り定義する。16.1. デプロイフロー (確定)開発者が develop → main ブランチへプルリクエスト。コードレビューと承認。main ブランチにマージ。GitHub Actions がトリガーされる。CI (テスト): PHPStan, PHPUnit, Pest を実行。CD (デプロイ): CI成功後、ssh-action を使用して Xserver VPS に接続。php artisan down（メンテモードON）→ デプロイコマンド（16.3.2参照）実行 → php artisan up（メンテモードOFF）。(Flutter) ストア（App Store, Google Play）へのアップロードは 手動 または Codemagic/Fastlane（別途構築）で行う。16.2. CI/CDパイプライン (GitHub Actions) .github/workflows/deploy_laravel.yml基本設計書 に基づき、以下のワークフローを定義する。YAMLname: Deploy Laravel to Production

on:
  push:
    branches:
      - main  # main ブランチへの push でトリガー

jobs:
  test_laravel:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2' # Laravel 10 の要件
          extensions: mbstring, dom, fileinfo, mysql
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader
      - name: Generate key
        run: php artisan key:generate
      - name: Run PHPStan (Static Analysis)
        run: ./vendor/bin/phpstan analyse --level=5 app/
      - name: Run Tests (PHPUnit/Pest)
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'
        run: php artisan test --coverage-clover=coverage.xml
      # (カバレッジレポートのアップロードやSlack通知など)

  deploy_laravel:
    name: Deploy to VPS
    needs: test_laravel # test_laravel ジョブの成功が必須
    runs-on: ubuntu-latest
    if: success() # テストが成功した場合のみ実行
    
    steps:
      - name: Deploy to Production (Xserver VPS)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }} # GitHub Secrets
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22 # (Xserver VPSがSSHキー認証対応の場合)
          
          script: |
            cd /var/www/grass-baseball-matching
            
            # 1. メンテナンスモード有効化
            php artisan down
            
            # 2. リポジトリから最新コードを取得
            git pull origin main
            
            # 3. Composer インストール (本番用)
            composer install --no-dev --optimize-autoloader
            
            # 4. データベースマイグレーション実行
            php artisan migrate --force
            
            # 5. キャッシュのクリアと再作成
            php artisan cache:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # 6. (オプション) キューワーカーの再起動
            php artisan queue:restart
            
            # 7. メンテナンスモード解除
            php artisan up
16.3. 環境構築・デプロイ手順詳細1. Nginx設定ファイル (確定)/etc/nginx/sites-available/grass-baseball-matching基本設計書 に記載のNginx設定（HTTPSリダイレクト、SSL、PHP-FPM、セキュリティヘッダー、.env 拒否）を確定仕様とする。Nginxserver {
    listen 80;
    server_name yourdomain.com;
    # (Let's Encrypt 用 .well-known の許可)
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt;
        allow all;
    }
    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    root /var/www/grass-baseball-matching/public;
    index index.php;

    ssl_certificate /path/to/ssl/fullchain.pem;
    ssl_certificate_key /path/to/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # (セキュリティヘッダーなど)

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock; # (環境依存)
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\. {
        deny all; # .env, .git へのアクセス拒否
    }
}
2. Laravelデプロイコマンド (確定)CI/CD（16.2）または手動デプロイで使用するコマンド一覧。Bashphp artisan down
git pull origin main
composer install --no-dev --optimize-autoloader
php artisan migrate --force
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan queue:restart
php artisan up
3. Flutterビルドコマンド (確定)iOS (App Store Connect)Bashflutter build ipa --release --export-options-plist=ExportOptions.plist
# (Transporter.app または fastlane でアップロード)
Android (Google Play Console)Bashflutter build appbundle --release
# (Google Play Console または fastlane でアップロード)
16.4. 環境変数一覧 (.env) (確定)基本設計書 に記載の全環境変数を確定仕様とする。Bash# アプリケーション基本設定
APP_NAME="GrassBaseballMatching"
APP_ENV=production
APP_KEY= # (php artisan key:generate で生成)
APP_DEBUG=false
APP_URL=https://yourdomain.com

# ログ設定
LOG_CHANNEL=daily
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=info
LOG_SLACK_WEBHOOK_URL= # (第13章で定義)
LOG_SLACK_LEVEL=critical # (第13章で定義)

# データベース設定 (Xserver VPS)
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=grass_baseball_matching
DB_USERNAME=db_user
DB_PASSWORD=secure_password

# キャッシュ/キュー
QUEUE_CONNECTION=database # 非同期処理のため
# (他は file デフォルト)

# SMTP (メール送信) 設定 (Xserver)
MAIL_MAILER=smtp
MAIL_HOST=your-xserver-smtp-host.com
MAIL_PORT=587
MAIL_USERNAME=your-smtp-username
MAIL_PASSWORD=your-smtp-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="support@yourdomain.com"
MAIL_FROM_NAME="${APP_NAME}"

# Sanctum (認証) 設定
SANCTUM_STATEFUL_DOMAINS=yourdomain.com

# FCM (Firebase) 設定
FCM_SERVER_KEY= # (Firebaseサービスアカウントキー)

# (APMツール)
NEW_RELIC_LICENSE_KEY= # (第13章で定義)
NEW_RELIC_APP_NAME="${APP_NAME}"
16.5. コード生成AIへの共通コンテキスト (第16章)目的:第16章の定義に基づき、CI/CDパイプラインの実装、および「環境構築手順書」「デプロイ手順書」を作成する。指示:CI/CDパイプラインの実装 (GitHub Actions):リポジトリの .github/workflows/ 配下に、「16.2. CI/CDパイプライン」の deploy_laravel.yml を 完全に 実装してください。GitHubリポジトリの Settings > Secrets に、VPS_HOST, VPS_USERNAME, VPS_SSH_KEY を登録するよう、開発者に指示してください。Flutterビルド環境の構築:Flutterのビルドに必要な署名ファイル（Keystore, Provisioning Profile）を安全に管理する方法（例: GitHub Secrets + fastlane match）を決定し、その手順を「Flutterデプロイ手順書」として文書化してください。「環境構築手順書」の作成:以下の手順を含む詳細なMarkdownファイル（ENVIRONMENT_SETUP.md）を作成してください。(1) Xserver VPS の契約とOSセットアップ(2) Nginx, PHP, MySQL 8.0, Composer, Git のインストール(3) 「16.3.1. Nginx設定ファイル」の設置と有効化(4) SSL証明書（Let's Encrypt）の取得とNginxへの設定(5) git clone と composer install(6) 第14章 の手順に基づく「.envファイル」の設置（「16.4.」の内容）(7) php artisan key:generate(8) php artisan migrate --seed（第17章）(9) php artisan storage:link(10) 第11章 で定義した crontab（schedule:run）の設定(11) 第13章 で定義した New Relic エージェントのインストール「デプロイ手順書」の作成:以下の手順を含むMarkdownファイル（DEPLOYMENT.md）を作成してください。(1) 自動デプロイ: main ブランチへのマージ（「16.1.」のフロー）(2) 手動デプロイ（緊急時）: 「16.3.2. Laravelデプロイコマンド」をサーバー上で順番に実行する手順第17章 移行設計 (詳細定義)基本設計書 第17章 の「詳細設計への共通コンテキスト」で指示されたタスク（Seederの実装、migrate --seed の手順化）に基づき、初期データ投入仕様を以下の通り定義する。17.1. データ移行要否 (確定)不要本システムは新規構築であり、既存システムからのデータ移行は発生しない。17.2. 初期データ投入本番環境の稼働に必要な初期データを、Laravel Seeder を使用して投入する。投入タイミングは、第16章の「環境構築手順書」の初回セットアップ時、および php artisan migrate:fresh 実行時とする。1. database/seeders/AdminUserSeeder.php (実装)基本設計書 に基づき、初期管理者アカウントを作成する。PHP<?php
namespace Database\Seeders;

use Illuminate:Database\Seeder;
use App\Models\User;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

class AdminUserSeeder extends Seeder
{
    public function run(): void
    {
        User::firstOrCreate(
            ['email' => 'admin@yourdomain.com'], // 検索キー
            [
                'user_id' => (string) Str::uuid(),
                'password' => Hash::make('password'), // "password"
                'nickname' => 'かんり',
                'created_at' => now(),
                'updated_at' => now(),
            ]
        );
    }
}
2. database/seeders/DatabaseSeeder.php (実装)上記 Seeder を呼び出す。PHP<?php
namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $this->call([
            AdminUserSeeder::class,
        ]);

        // 開発環境のみ、テスト用データを投入
        if (app()->environment('local')) {
            // $this->call(TestGameSeeder::class); 
        }
    }
}
17.3. コード生成AIへの共通コンテキスト (第17章)目的:第17章の定義に基づき、初期データ投入用のSeederクラスを実装し、デプロイ手順に組み込む。指示:Seederの実装 (Laravel):database/seeders/ 配下に、「17.2.1. AdminUserSeeder.php」と「17.2.2. DatabaseSeeder.php」を、記載されているPHPコードの通りに 完全に 実装してください。（TestGameSeeder は、Game::factory()->count(10)->create() のようなダミーデータ生成ロジックとして任意で実装してください）デプロイ手順への反映 (Laravel):第16章 で作成する「環境構築手順書」（ENVIRONMENT_SETUP.md）の初回セットアップ手順の 最後 に、php artisan migrate --seed コマンドを実行するステップを 必ず 追加してください。2回目以降のデプロイ（DEPLOYMENT.md）では、php artisan migrate --force（--seed なし）を使用することを明記してください。第18章 制約事項・前提条件 (詳細定義)基本設計書 第18章 の「詳細設計への共通コンテキスト」で指示されたタスク（制約の反映、オフライン/トークンリフレッシュハンドリングの実装）に基づき、全設計・実装の前提となる制約を以下の通り確定する。18.1. インフラ制約 (確定)ホスティング: Xserver VPSミドルウェア: MySQL 8.0, Nginxスケーリング: 単一サーバー構成。負荷増大時は垂直スケーリング（プラン変更）で対応。18.2. 外部サービス制約 (確定)プッシュ通知: Firebase Cloud Messaging (FCM)メール送信: Xserver SMTP（送信上限数に注意）地図: Google Maps (ディープリンク) のみ。SDKの組み込みは行わない。18.3. 技術的制約 (確定)技術スタックの固定: Laravel 10, Flutter, Sanctum, Riverpod 2.x。これ以外の技術導入は禁止。リフレッシュトークン非採用: APIトークン有効期限は24時間。期限切れ時は必ず再ログイン（F-USR-002）を要求。オフライン非対応: 非機能要件 に基づき、常時通信可能であることを前提とする。オフライン時のデータ閲覧・操作はサポート対象外。18.4. コード生成AIへの共通コンテキスト (第18章)目的:第18章の制約に基づき、特にクライアント側のエラーハンドリングを実装する。指示:制約の遵守:すべてのコード生成において、「18.1」?「18.3」の制約（例: MySQL 8.0 構文の使用、Riverpod の使用）を 厳密に 遵守してください。リフレッシュトークン非採用の実装 (Flutter):第7章 の「コード生成AIへの共通コンテキスト」で指示した**「HTTP 401ハンドリング」**（Interceptor で401 を検知し、TokenStorageService.deleteToken() を呼び出し、SCR-USR-001 (ログイン画面) に強制遷移させる）ロジックを 必ず 実装してください。オフライン非対応の実装 (Flutter):APIクライアント（Dioなど）の Interceptor で、SocketException や DioExceptionType.connectionError などの通信切断エラーをキャッチしてください。キャッチした場合、Provider の状態を AsyncError にし、「通信環境の良い場所で再度お試しください」という内容の Dialog または SnackBar を表示する共通エラーハンドリング処理を実装してください。オフライン用のローカルDB（SQLite, Hiveなど）は 一切実装しないでください。第19章 用語集 (詳細定義)基本設計書 第19章 の「詳細設計への共通コンテキスト」で指示されたタスク（用語の統一）に基づき、プロジェクトで使用する用語を以下の通り確定する。19.1. 技術用語 (確定)用語説明Laravelバックエンド（APIサーバー）で使用するPHPフレームワーク。Flutterクライアント（iOS/Androidアプリ）で使用するUIフレームワーク。SanctumLaravel の認証ライブラリ。PAT (Personal Access Token) 方式を採用。RiverpodFlutter の状態管理ライブラリ（固定ルール）。Bcryptパスワードハッシュ化アルゴリズム（固定ルール）。FCMFirebase Cloud Messaging。プッシュ通知配信サービス。Haversine formula球面上の2地点間の距離計算式（固定ルール）。PATPersonal Access Token。Sanctum が発行する認証トークン。19.2. ドメイン用語 (確定)用語説明試合games テーブルで管理される、草野球の開催情報。参加者試合に参加登録したユーザー。参加登録F-USR-006。ユーザーが試合に参加（チーム・ポジション選択）すること。チェックインF-USR-008。参加者が試合当日に会場付近で、指定時間内に位置情報を送信し、来場を確定させる処理。許容半径acceptable_radius。チェックインを許可する会場からの半径（メートル）。論理削除deleted_at カラムに日時を記録する削除方式。管理者F-ADM-XXX。ユーザー管理や試合管理が可能な特権ユーザー。19.3. コード生成AIへの共通コンテキスト (第19章)目的:第19章の定義に基づき、全ドキュメント、コード、UIテキストの用語を統一し、一貫性を担保する。指示:用語の厳格な統一:これから生成するすべてのコード（変数名、関数名、クラス名）、コメント、およびUI上のテキスト（ボタン名、エラーメッセージ）において、「19.2. ドメイン用語」で定義された用語を 厳密に 使用してください。例1: 「来場確認」「出席」といった用語は 使用禁止 です。必ず「チェックイン」を使用してください。例2: 「試合に参加する」ロジックのクラス名は JoinGameService ではなく、ParticipationService（参加登録）や GameService@addParticipant としてください。例3: user_id は id と省略せず、game_id も id と省略せず、DB定義 に従って明確に命名してください。例4: 「ニックネーム」は「ハンドルネーム」や「ユーザー名」と表記せず、必ず「ニックネーム」を使用してください。