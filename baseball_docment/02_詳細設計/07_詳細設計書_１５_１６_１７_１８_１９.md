# 詳細設計書：草野球マッチングアプリ

## 第15章 デプロイ・インフラ設計 (詳細定義)

基本設計書 第15章 の「詳細設計への共通コンテキスト」で指示されたタスク（サーバー設定、デプロイ手順、バックアップ設定）に基づき、デプロイとインフラの詳細仕様を以下の通り定義する。

### 15.1 システム構成図 (確定)

```
┌─────────────────┐
│  Flutter App    │
│  (iOS/Android)  │
└────────┬────────┘
         │ HTTPS (REST API)
         ▼
┌─────────────────┐
│     Nginx       │ (Webサーバー)
└────────┬────────┘
         │ FastCGI
         ▼
┌─────────────────┐
│   Laravel 10    │ (アプリケーション)
└────────┬────────┘
         │
    ┌────┴────┬────────────┐
    │         │            │
    ▼         ▼            ▼
┌──────┐  ┌──────┐  ┌──────────┐
│ MySQL│  │ Redis│  │ Firebase │
│  8.0 │  │      │  │   FCM    │
└──────┘  └──────┘  └──────────┘
```

### 15.2 サーバースペック (確定)

**プロバイダー:** Xserver VPS

**プラン:** 2GBプラン

| 項目 | スペック |
|---|---|
| CPU | 3コア |
| メモリ | 2GB |
| ストレージ | 50GB SSD |
| OS | Ubuntu 24.04 LTS |
| 転送量 | 無制限 |

### 15.3 Nginx設定ファイル

#### /etc/nginx/sites-available/grassballapp

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com;

    # HTTPSへリダイレクト
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com;

    # SSL証明書（Let's Encrypt）
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # SSL設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers on;

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    root /var/www/grassballapp/public;
    index index.php;

    # 最大アップロードサイズ
    client_max_body_size 5M;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # 静的ファイルのキャッシュ
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # .htaccess, .gitなどへのアクセス拒否
    location ~ /\. {
        deny all;
    }
}
```

### 15.4 MySQL設定ファイル

#### /etc/mysql/my.cnf

```ini
[mysqld]
# 文字コード
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 接続数
max_connections = 100

# バッファプール
innodb_buffer_pool_size = 512M

# ログファイル
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 1

# タイムゾーン
default-time-zone = '+09:00'
```

### 15.5 デプロイ手順

#### 初回デプロイ

```bash
# 1. 必要なパッケージのインストール
sudo apt update
sudo apt install -y nginx php8.2-fpm php8.2-mysql php8.2-xml php8.2-mbstring \
    php8.2-curl php8.2-zip php8.2-gd mysql-server redis-server

# 2. Composerのインストール
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# 3. プロジェクトのクローン
cd /var/www
sudo git clone https://github.com/yourusername/grassballapp.git
cd grassballapp

# 4. 依存関係のインストール
composer install --no-dev --optimize-autoloader

# 5. 環境変数の設定
cp .env.example .env
sudo nano .env
# APP_ENV=production
# APP_DEBUG=false
# DB設定、SMTP設定などを記入

# 6. アプリケーションキーの生成
php artisan key:generate

# 7. データベースのマイグレーション
php artisan migrate --force
php artisan db:seed --force

# 8. ストレージディレクトリの権限設定
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache

# 9. Nginx設定の有効化
sudo ln -s /etc/nginx/sites-available/grassballapp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 10. SSL証明書の取得（Let's Encrypt）
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com

# 11. Cronの設定
sudo crontab -e
# 以下を追加
# * * * * * cd /var/www/grassballapp && php artisan schedule:run >> /dev/null 2>&1
```

#### 更新デプロイ（GitHub Actions）

`.github/workflows/deploy.yml`

```yaml
name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/grassballapp
            git pull origin main
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            sudo systemctl restart php8.2-fpm
```

### 15.6 バックアップ戦略

#### データベースバックアップスクリプト

`/root/backup_db.sh`

```bash
#!/bin/bash

# バックアップディレクトリ
BACKUP_DIR="/root/backups/mysql"
DATE=$(date +"%Y%m%d_%H%M%S")

# バックアップ実行
mysqldump -u root -p'your_password' grassballapp > "$BACKUP_DIR/grassballapp_$DATE.sql"

# 14日以上前のバックアップを削除
find $BACKUP_DIR -name "*.sql" -mtime +14 -delete

echo "Database backup completed: grassballapp_$DATE.sql"
```

**Cron設定:**

```bash
# 毎日深夜3時にバックアップ
0 3 * * * /root/backup_db.sh >> /var/log/backup.log 2>&1
```

**ファイルバックアップ:**

- 対象: `storage/app/public/`（画像ファイル等）
- 方法: rsyncまたはXserver VPSのスナップショット機能を使用

### 15.7 コード生成AIへの共通コンテキスト (第15章)

**目的:**

第15章の定義に基づき、デプロイとインフラの設定を実装する。

**指示:**

- 「15.3 Nginx設定ファイル」を `/etc/nginx/sites-available/` に配置してください
- 「15.4 MySQL設定ファイル」を `/etc/mysql/my.cnf` に反映してください
- 「15.5 デプロイ手順」に従って初回デプロイを実行してください
- 「15.6 バックアップスクリプト」を作成し、Cronに登録してください

---

## 第16章 監視・運用設計 (詳細定義)

基本設計書 第16章 の「詳細設計への共通コンテキスト」で指示されたタスク（監視設定、ログ運用、障害対応手順）に基づき、監視と運用の詳細仕様を以下の通り定義する。

### 16.1 監視項目 (確定)

#### サーバー監視

| 項目 | 閾値 | アラート条件 |
|---|---|---|
| CPU使用率 | 80%以上 | 5分間継続 |
| メモリ使用率 | 85%以上 | 5分間継続 |
| ディスク使用率 | 80%以上 | - |

#### アプリケーション監視

| 項目 | 閾値 | アラート条件 |
|---|---|---|
| APIエラー率 | 5%以上 | 5分間の平均 |
| レスポンスタイム | 1秒以上 | 5分間の平均 |
| 連続ログイン失敗 | 10回以上/分 | - |

#### データベース監視

| 項目 | 閾値 | アラート条件 |
|---|---|---|
| スロークエリ | 10件以上/時 | - |
| 接続数 | 80以上 | - |

### 16.2 ログ運用

#### ログ保存期間

| ログ種類 | 保存期間 | ローテーション |
|---|---|---|
| Nginxアクセスログ | 30日 | 日次 |
| Nginxエラーログ | 30日 | 日次 |
| Laravelログ | 14日 | 日次 |
| MySQLスロークエリログ | 7日 | 週次 |

#### ログ確認手順

```bash
# Laravelログの確認
tail -f /var/www/grassballapp/storage/logs/laravel.log

# 特定のエラーを検索
grep "E-500" /var/www/grassballapp/storage/logs/laravel.log

# Nginxエラーログの確認
tail -f /var/log/nginx/error.log

# MySQLスロークエリの確認
pt-query-digest /var/log/mysql/slow-query.log
```

### 16.3 障害対応フロー

#### 1. 障害検知

- 監視ツールからアラート受信
- ユーザーからの問い合わせ

#### 2. 初動対応

```bash
# サービス状態確認
sudo systemctl status nginx
sudo systemctl status php8.2-fpm
sudo systemctl status mysql
sudo systemctl status redis

# リソース確認
top
df -h
free -h
```

#### 3. 復旧作業

```bash
# サービス再起動
sudo systemctl restart php8.2-fpm
sudo systemctl restart nginx

# キャッシュクリア
cd /var/www/grassballapp
php artisan cache:clear
php artisan config:clear
php artisan route:clear
```

#### 4. 事後対応

- 原因調査
- 再発防止策の検討
- 障害報告書の作成

### 16.4 定期メンテナンス

#### 月次作業

1. バックアップの確認（リストア テスト）
2. ログの分析
3. セキュリティアップデートの適用
4. ディスク容量の確認

#### セキュリティアップデート手順

```bash
# パッケージ更新
sudo apt update
sudo apt upgrade -y

# Composer依存関係の更新
cd /var/www/grassballapp
composer update

# 脆弱性チェック
composer audit
```

### 16.5 コード生成AIへの共通コンテキスト (第16章)

**目的:**

第16章の定義に基づき、監視と運用の仕組みを構築する。

**指示:**

- 「16.1 監視項目」に基づき、監視ツール（New Relic, Datadog等）を設定してください
- 「16.2 ログ運用」に基づき、ログローテーションを設定してください
- 「16.3 障害対応フロー」をドキュメント化し、運用担当者と共有してください

---

## 第17章 セキュリティ運用 (詳細定義)

基本設計書 第17章 の「詳細設計への共通コンテキスト」で指示されたタスク（アクセス制御、脆弱性診断、インシデント対応）に基づき、セキュリティ運用の詳細仕様を以下の通り定義する。

### 17.1 アクセス制御

#### SSH接続制限

```bash
# /etc/ssh/sshd_config
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
```

#### ファイアウォール設定（UFW）

```bash
# UFWの有効化
sudo ufw enable

# 必要なポートのみ開放
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS

# その他は拒否
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

### 17.2 脆弱性診断

#### 定期診断スケジュール

| 対象 | 頻度 | 手法 |
|---|---|---|
| Webアプリケーション | 半年ごと | OWASP ZAP |
| サーバー | 半年ごと | Nessus / OpenVAS |
| 依存ライブラリ | 毎週 | composer audit |

#### 脆弱性対応フロー

1. 脆弱性の検出
2. 影響評価（Critical / High / Medium / Low）
3. 対応計画の策定
4. パッチ適用
5. 再診断

**対応期限:**

- Critical / High: 24時間以内
- Medium: 1週間以内
- Low: 1ヶ月以内

### 17.3 インシデント対応

#### インシデント種別

1. 不正アクセス
2. データ漏洩
3. サービス停止
4. 不正利用

#### インシデント対応フロー

1. **検知**: ログ、監視ツール、通報
2. **初動対応**: 
   - 攻撃の遮断（IPブロック等）
   - 証拠保全（ログのバックアップ）
3. **原因調査**: ログ分析、脆弱性調査
4. **恒久対策**: パッチ適用、設定変更
5. **再発防止策**: 監視強化、教育
6. **報告**: 関係者への報告、必要に応じて当局への届出

#### インシデント対応コマンド例

```bash
# 不正アクセス元IPのブロック
sudo ufw deny from 192.168.1.100

# 該当ユーザーのアカウント無効化
cd /var/www/grassballapp
php artisan tinker
>>> User::where('email', 'suspicious@example.com')->update(['deleted_at' => now()]);

# ログの確保
sudo cp /var/log/nginx/access.log /root/incident_$(date +%Y%m%d)/
sudo cp /var/www/grassballapp/storage/logs/laravel.log /root/incident_$(date +%Y%m%d)/
```

### 17.4 コード生成AIへの共通コンテキスト (第17章)

**目的:**

第17章の定義に基づき、セキュリティ運用の仕組みを構築する。

**指示:**

- 「17.1 アクセス制御」に基づき、SSH設定とファイアウォールを設定してください
- 「17.2 脆弱性診断」のスケジュールに従い、定期診断を実施してください
- 「17.3 インシデント対応」のフローをドキュメント化し、担当者に周知してください

---

## 第18章 ドキュメント管理 (詳細定義)

基本設計書 第18章 の「詳細設計への共通コンテキスト」で指示されたタスク（ドキュメント整備、API仕様書生成、ER図生成）に基づき、ドキュメント管理の詳細仕様を以下の通り定義する。

### 18.1 ドキュメント一覧 (確定)

| ドキュメント名 | 形式 | 更新頻度 | 保管場所 |
|---|---|---|---|
| 要件定義書 | Markdown | 初期のみ | Git |
| 基本設計書 | Markdown | 設計変更時 | Git |
| 詳細設計書 | Markdown | 実装変更時 | Git |
| API仕様書 | Swagger | 実装変更時 | `/api/documentation` |
| データベース設計書 | DBML | DB変更時 | dbdocs.io |
| インフラ構築手順書 | Markdown | 構成変更時 | Git |
| 運用手順書 | Markdown | 手順変更時 | Git |
| テスト仕様書 | Markdown | テスト追加時 | Git |
| リリースノート | Markdown | リリース時 | Git |

### 18.2 API仕様書（Swagger）

#### 導入

```bash
composer require darkaonline/l5-swagger
php artisan vendor:publish --provider "L5Swagger\L5SwaggerServiceProvider"
```

#### Swaggerアノテーション例

```php
<?php

namespace App\Http\Controllers;

use OpenApi\Annotations as OA;

/**
 * @OA\Info(
 *     version="1.0.0",
 *     title="草野球マッチングアプリ API",
 *     description="草野球マッチングアプリのAPI仕様書"
 * )
 */
class AuthController extends Controller
{
    /**
     * @OA\Post(
     *     path="/api/v1/auth/login",
     *     summary="ログイン",
     *     tags={"認証"},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"email","password"},
     *             @OA\Property(property="email", type="string", format="email", example="user@example.com"),
     *             @OA\Property(property="password", type="string", example="password123")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="ログイン成功",
     *         @OA\JsonContent(
     *             @OA\Property(property="data", type="object",
     *                 @OA\Property(property="user", type="object",
     *                     @OA\Property(property="user_id", type="string"),
     *                     @OA\Property(property="email", type="string"),
     *                     @OA\Property(property="nickname", type="string")
     *                 ),
     *                 @OA\Property(property="token", type="string")
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="認証失敗")
     * )
     */
    public function login(LoginRequest $request)
    {
        // 実装
    }
}
```

#### Swagger生成

```bash
php artisan l5-swagger:generate
```

アクセス: `https://yourdomain.com/api/documentation`

### 18.3 データベース設計書（dbdocs.io）

#### DBML記法

`database.dbml`

```dbml
Table users {
  user_id char(36) [pk]
  email varchar(254) [unique, not null]
  password varchar(255) [not null]
  nickname varchar(4) [not null]
  created_at timestamp [not null]
  updated_at timestamp [not null]
  deleted_at timestamp [null]
}

Table games {
  game_id char(36) [pk]
  place_name varchar(254) [not null]
  game_date_time timestamp [not null]
  address varchar(254) [not null]
  prefecture varchar(10) [not null]
  latitude decimal(10,7) [not null]
  longitude decimal(10,7) [not null]
  acceptable_radius int [not null]
  fee int [null]
  capacity int [not null]
  status enum('募集中', '満員', '開催済み') [not null, default: '募集中']
  created_at timestamp [not null]
  updated_at timestamp [not null]
}

Table participations {
  participation_id char(36) [pk]
  user_id char(36) [not null]
  game_id char(36) [not null]
  team_division enum('チームA', 'チームB') [not null]
  position enum('投手', '捕手', '一塁手', '二塁手', '三塁手', '遊撃手', '左翼手', '中堅手', '右翼手') [not null]
  status enum('参加確定', 'チェックイン済') [not null, default: '参加確定']
  created_at timestamp [not null]
  updated_at timestamp [not null]
}

Table device_tokens {
  device_token_id char(36) [pk]
  user_id char(36) [not null]
  fcm_token varchar(255) [not null]
  device_type enum('ios', 'android') [not null]
  created_at timestamp [not null]
  updated_at timestamp [not null]
}

Ref: participations.user_id > users.user_id
Ref: participations.game_id > games.game_id
Ref: device_tokens.user_id > users.user_id
```

#### dbdocs.ioへのアップロード

```bash
npm install -g dbdocs
dbdocs build database.dbml
```

### 18.4 リリースノート

#### テンプレート

```markdown
# v1.0.0 (2025-11-01)

## 新機能

- ユーザー登録・ログイン機能
- 試合一覧・詳細表示機能
- 試合参加登録機能
- チェックイン機能

## 改善

- なし

## バグ修正

- なし

## 既知の問題

- なし
```

### 18.5 コード生成AIへの共通コンテキスト (第18章)

**目的:**

第18章の定義に基づき、ドキュメントを整備する。

**指示:**

- 「18.2 API仕様書」に基づき、Swagger アノテーションを全コントローラーに追加してください
- 「18.3 データベース設計書」に基づき、database.dbml を作成し、dbdocs.io にアップロードしてください
- 「18.4 リリースノート」のテンプレートに従い、リリース時にバージョン情報を記載してください

---

## 第19章 最終チェックリスト

### 19.1 実装完了チェックリスト

#### Laravel (Backend)

- [ ] 全18機能のAPI実装
- [ ] 全FormRequestのバリデーション実装
- [ ] 全Serviceクラスのビジネスロジック実装
- [ ] 全Repositoryクラスのデータアクセス実装
- [ ] AdminMiddleware実装
- [ ] レートリミット設定
- [ ] FCM通知実装
- [ ] メール配信実装
- [ ] バッチ処理実装（3種）
- [ ] エラーハンドリング実装
- [ ] テストコード実装（カバレッジ80%以上）
- [ ] Swaggerアノテーション追加

#### Flutter (Frontend)

- [ ] 全7画面の実装
- [ ] 全機能の状態管理（Riverpod）
- [ ] トークン管理（flutter_secure_storage）
- [ ] FCM実装
- [ ] 位置情報取得実装
- [ ] チェックイン実装
- [ ] エラーハンドリング実装
- [ ] テストコード実装（カバレッジ70%以上）

#### インフラ

- [ ] Xserver VPSセットアップ
- [ ] Nginx設定
- [ ] MySQL設定
- [ ] Redis設定
- [ ] SSL証明書取得
- [ ] Cron設定
- [ ] バックアップスクリプト設定
- [ ] ファイアウォール設定

#### ドキュメント

- [ ] API仕様書（Swagger）
- [ ] データベース設計書（dbdocs.io）
- [ ] インフラ構築手順書
- [ ] 運用手順書
- [ ] リリースノート

### 19.2 リリース前チェックリスト

- [ ] 本番環境での動作確認
- [ ] セキュリティ診断実施
- [ ] パフォーマンステスト実施
- [ ] バックアップ・リストアテスト実施
- [ ] 障害対応手順の確認
- [ ] 監視設定の確認
- [ ] ログ確認手順の確認

---

**詳細設計書 完**
