# 詳細設計書：草野球マッチングアプリ

## 第12章 エラーハンドリング設計 (詳細定義)

基本設計書 第12章 の「詳細設計への共通コンテキスト」で指示されたタスク（Handler実装、カスタム例外実装、Flutter側実装）に基づき、エラーハンドリングの詳細仕様を以下の通り定義する。

### 12.1 Laravel Exception Handler実装

#### app/Exceptions/Handler.php

```php
<?php

namespace App\Exceptions;

use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
use Illuminate\Validation\ValidationException;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Auth\Access\AuthorizationException;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Throwable;

class Handler extends ExceptionHandler
{
    public function register()
    {
        $this->renderable(function (Throwable $e, $request) {
            if ($request->is('api/*')) {
                return $this->handleApiException($e, $request);
            }
        });
    }

    private function handleApiException(Throwable $e, $request)
    {
        // バリデーションエラー (422)
        if ($e instanceof ValidationException) {
            return response()->json([
                'error' => [
                    'code' => 'E-422-00',
                    'message' => 'バリデーションエラーが発生しました',
                    'details' => $this->formatValidationErrors($e->errors())
                ],
                'meta' => ['timestamp' => now()->toIso8601String()]
            ], 422);
        }

        // 認証エラー (401)
        if ($e instanceof AuthenticationException) {
            return response()->json([
                'error' => [
                    'code' => 'E-401-01',
                    'message' => '認証に失敗しました',
                    'details' => []
                ],
                'meta' => ['timestamp' => now()->toIso8601String()]
            ], 401);
        }

        // 認可エラー (403)
        if ($e instanceof AuthorizationException) {
            return response()->json([
                'error' => [
                    'code' => 'E-403-01',
                    'message' => '管理者権限が必要です',
                    'details' => []
                ],
                'meta' => ['timestamp' => now()->toIso8601String()]
            ], 403);
        }

        // Not Found (404)
        if ($e instanceof ModelNotFoundException) {
            return response()->json([
                'error' => [
                    'code' => 'E-404-00',
                    'message' => 'リソースが見つかりません',
                    'details' => []
                ],
                'meta' => ['timestamp' => now()->toIso8601String()]
            ], 404);
        }

        // その他のエラー (500)
        return response()->json([
            'error' => [
                'code' => 'E-500-03',
                'message' => 'サーバーエラーが発生しました',
                'details' => []
            ],
            'meta' => ['timestamp' => now()->toIso8601String()]
        ], 500);
    }

    private function formatValidationErrors(array $errors): array
    {
        $details = [];
        foreach ($errors as $field => $messages) {
            $details[] = [
                'field' => $field,
                'message' => $messages[0]
            ];
        }
        return $details;
    }
}
```

### 12.2 カスタム例外クラス (Laravel)

#### app/Exceptions/CheckinException.php

```php
<?php

namespace App\Exceptions;

use Exception;

class CheckinException extends Exception
{
    private string $errorCode;

    public function __construct(string $message, string $errorCode, int $httpStatus = 400)
    {
        parent::__construct($message, $httpStatus);
        $this->errorCode = $errorCode;
    }

    public function getErrorCode(): string
    {
        return $this->errorCode;
    }

    public function render($request)
    {
        return response()->json([
            'error' => [
                'code' => $this->errorCode,
                'message' => $this->getMessage(),
                'details' => []
            ],
            'meta' => ['timestamp' => now()->toIso8601String()]
        ], $this->getCode());
    }
}
```

### 12.3 Flutter エラーハンドリング実装

#### lib/core/services/api_client.dart

```dart
import 'package:dio/dio.dart';

class ApiClient {
  final Dio _dio;

  ApiClient(this._dio) {
    _dio.interceptors.add(InterceptorsWrapper(
      onError: (DioException e, ErrorInterceptorHandler handler) {
        if (e.response != null) {
          final statusCode = e.response!.statusCode;
          final errorData = e.response!.data;

          // APIエラーレスポンスをパース
          final apiException = ApiException.fromResponse(
            statusCode: statusCode ?? 0,
            errorCode: errorData['error']['code'] ?? 'UNKNOWN',
            message: errorData['error']['message'] ?? 'エラーが発生しました',
            details: errorData['error']['details'] ?? [],
          );

          return handler.reject(DioException(
            requestOptions: e.requestOptions,
            error: apiException,
          ));
        }

        return handler.next(e);
      },
    ));
  }
}

class ApiException implements Exception {
  final int statusCode;
  final String errorCode;
  final String message;
  final List<dynamic> details;

  ApiException({
    required this.statusCode,
    required this.errorCode,
    required this.message,
    required this.details,
  });

  factory ApiException.fromResponse({
    required int statusCode,
    required String errorCode,
    required String message,
    required List<dynamic> details,
  }) {
    return ApiException(
      statusCode: statusCode,
      errorCode: errorCode,
      message: message,
      details: details,
    );
  }
}
```

### 12.4 エラー表示ルール (Flutter)

| HTTPステータス | 表示方法 | 表示場所 |
|---|---|---|
| 401 | トースト | 画面下部 |
| 403 | ダイアログ | 画面中央 |
| 404 | トースト | 画面下部 |
| 409 | トースト | 画面下部 |
| 422 | インライン | 各入力フィールド下 |
| 500 | ダイアログ | 画面中央 |

### 12.5 コード生成AIへの共通コンテキスト (第12章)

**目的:**

第12章の定義に基づき、エラーハンドリングの完全な実装を行う。

**指示:**

#### Laravel実装:

- `app/Exceptions/Handler.php` に、「12.1 Laravel Exception Handler実装」のコードを **完全に** 実装してください
- `app/Exceptions/` に、必要なカスタム例外クラス（CheckinException.php など）を作成してください

#### Flutter実装:

- `lib/core/services/` に `ApiClient.dart` を作成し、「12.3 Flutter エラーハンドリング実装」のコードを **完全に** 実装してください
- 各画面で、「12.4 エラー表示ルール」に従ってエラーを表示してください

---

## 第13章 テスト設計 (詳細定義)

基本設計書 第13章 の「詳細設計への共通コンテキスト」で指示されたタスク（テストケース実装、CI/CD設定）に基づき、テストの詳細仕様を以下の通り定義する。

### 13.1 テスト方針 (確定)

**テストレベル:**

1. **単体テスト (Unit Test)**: 個別のクラス・関数のテスト
2. **統合テスト (Integration Test)**: 複数のクラス・API連携のテスト
3. **E2Eテスト (End-to-End Test)**: ユーザー操作のフローテスト（今回は省略）

**カバレッジ目標:**

- Laravel: 80%以上
- Flutter: 70%以上

### 13.2 Laravel テスト設計

#### テストディレクトリ構造

```
tests/
  ├── Feature/          # 統合テスト (APIテスト)
  │   ├── AuthTest.php
  │   ├── GameTest.php
  │   └── CheckinTest.php
  └── Unit/             # 単体テスト
      ├── Services/
      │   ├── AuthServiceTest.php
      │   └── GameServiceTest.php
      └── Utils/
          └── DistanceCalculatorTest.php
```

#### テスト実装例: tests/Feature/AuthTest.php

```php
<?php

namespace Tests\Feature;

use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;
use App\Models\User;

class AuthTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function ログインに成功する()
    {
        // Arrange
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password123'),
        ]);

        // Act
        $response = $this->postJson('/api/v1/auth/login', [
            'email' => 'test@example.com',
            'password' => 'password123',
        ]);

        // Assert
        $response->assertStatus(200)
            ->assertJsonStructure([
                'data' => [
                    'user' => ['user_id', 'email', 'nickname'],
                    'token'
                ],
                'meta' => ['timestamp']
            ]);
    }

    /** @test */
    public function パスワードが間違っている場合はログインに失敗する()
    {
        // Arrange
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password123'),
        ]);

        // Act
        $response = $this->postJson('/api/v1/auth/login', [
            'email' => 'test@example.com',
            'password' => 'wrong-password',
        ]);

        // Assert
        $response->assertStatus(401)
            ->assertJson([
                'error' => [
                    'code' => 'E-401-02',
                    'message' => 'メールアドレスまたはパスワードが正しくありません'
                ]
            ]);
    }
}
```

### 13.3 Flutter テスト設計

#### テストディレクトリ構造

```
test/
  ├── unit/             # 単体テスト
  │   ├── providers/
  │   │   └── auth_provider_test.dart
  │   └── utils/
  │       └── distance_calculator_test.dart
  ├── widget/           # Widgetテスト
  │   ├── login_screen_test.dart
  │   └── game_list_screen_test.dart
  └── integration/      # 統合テスト (省略)
```

#### テスト実装例: test/unit/providers/auth_provider_test.dart

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:mockito/mockito.dart';

void main() {
  group('AuthProvider', () {
    test('ログインに成功するとトークンが保存される', () async {
      // Arrange
      final mockAuthRepository = MockAuthRepository();
      final mockTokenStorage = MockTokenStorageService();

      when(mockAuthRepository.login(any, any))
          .thenAnswer((_) async => LoginResponse(token: 'test-token'));

      // Act
      final container = ProviderContainer(
        overrides: [
          authRepositoryProvider.overrideWithValue(mockAuthRepository),
          tokenStorageProvider.overrideWithValue(mockTokenStorage),
        ],
      );

      await container.read(authProvider.notifier).login(
        email: 'test@example.com',
        password: 'password123',
      );

      // Assert
      verify(mockTokenStorage.saveToken('test-token')).called(1);
    });
  });
}
```

### 13.4 テスト実行方法

#### Laravel:

```bash
# 全テスト実行
php artisan test

# カバレッジ付き実行
php artisan test --coverage
```

#### Flutter:

```bash
# 全テスト実行
flutter test

# カバレッジ付き実行
flutter test --coverage
```

### 13.5 CI/CDパイプライン設定

#### .github/workflows/test.yml

```yaml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  laravel-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Install Dependencies
        run: composer install
      - name: Run Tests
        run: php artisan test --coverage

  flutter-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
      - name: Install Dependencies
        run: flutter pub get
      - name: Run Tests
        run: flutter test --coverage
```

### 13.6 コード生成AIへの共通コンテキスト (第13章)

**目的:**

第13章の定義に基づき、テストコードとCI/CD設定を実装する。

**指示:**

#### Laravel テスト実装:

- `tests/Feature/` と `tests/Unit/` に、主要な機能のテストケースを作成してください
- 「13.2 テスト実装例」を参考に、認証、試合管理、チェックイン等のテストを実装してください

#### Flutter テスト実装:

- `test/unit/` と `test/widget/` に、主要な機能のテストケースを作成してください
- `mockito` を使用してモックを作成し、単体テストを実装してください

#### CI/CD設定:

- `.github/workflows/` に `test.yml` を作成し、「13.5 CI/CDパイプライン設定」のコードを **完全に** 実装してください

---

## 第14章 パフォーマンス設計 (詳細定義)

基本設計書 第14章 の「詳細設計への共通コンテキスト」で指示されたタスク（キャッシュ実装、インデックス最適化、レートリミット実装）に基づき、パフォーマンス最適化の詳細仕様を以下の通り定義する。

### 14.1 パフォーマンス要件 (確定)

| 項目 | 目標値 |
|---|---|
| APIレスポンスタイム（単一リソース取得） | 200ms以内 |
| APIレスポンスタイム（一覧取得） | 500ms以内 |
| 同時接続数 | 100 |
| データベースクエリ実行時間 | 50ms以内 |

### 14.2 データベース最適化

#### インデックス設計 (確定)

基本設計書 第4章の「4.4. インデックス作成SQL文」を確定仕様とする。

```sql
-- users テーブル
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_deleted_at ON users(deleted_at);

-- games テーブル
CREATE INDEX idx_games_status ON games(status);
CREATE INDEX idx_games_game_date_time ON games(game_date_time);
CREATE INDEX idx_games_prefecture ON games(prefecture);

-- participations テーブル
CREATE INDEX idx_participations_user_id ON participations(user_id);
CREATE INDEX idx_participations_game_id ON participations(game_id);
CREATE INDEX idx_participations_status ON participations(status);

-- device_tokens テーブル
CREATE INDEX idx_device_tokens_user_id ON device_tokens(user_id);
```

#### N+1問題の回避

```php
// 悪い例
$games = Game::all();
foreach ($games as $game) {
    $participantCount = $game->participations->count(); // N+1発生
}

// 良い例
$games = Game::withCount('participations')->get();
foreach ($games as $game) {
    $participantCount = $game->participations_count;
}
```

### 14.3 キャッシュ戦略

**採用技術:** Redis

**キャッシュ対象:**

| データ | TTL | キー |
|---|---|---|
| 試合一覧 | 5分 | `games:list:{page}:{filters}` |
| 試合詳細 | 10分 | `game:{gameId}` |
| ユーザー詳細 | 30分 | `user:{userId}` |

**実装例:**

```php
// 試合詳細のキャッシュ
$game = Cache::remember("game:{$gameId}", 600, function () use ($gameId) {
    return $this->gameRepository->findById($gameId);
});

// キャッシュクリア（更新時）
Cache::forget("game:{$gameId}");
```

### 14.4 APIレートリミット

第7章で定義したレートリミットを確定仕様とする。

- 認証不要API: 60回/分/IP
- ログインAPI: 5回/分/IP
- 認証必須API: 120回/分/ユーザー

### 14.5 コード生成AIへの共通コンテキスト (第14章)

**目的:**

第14章の定義に基づき、パフォーマンス最適化を実装する。

**指示:**

- 「14.2 インデックス設計」に基づき、Migrationファイルにインデックス作成を追加してください
- Repository層で、Eager Loadingを使用してN+1問題を回避してください
- 「14.3 キャッシュ戦略」に基づき、頻繁にアクセスされるデータにキャッシュを実装してください
